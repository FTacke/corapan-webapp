{% extends 'base.html' %}

{% block title %}BlackLab Server Debug{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>üîç BlackLab Server Debug Dashboard</h1>
    <p class="text-muted">Local development tool for testing BlackLab Server and proxy configuration.</p>

    <hr/>

    <div class="row">
        <!-- Server Status -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5>üñ•Ô∏è Server Status</h5>
                </div>
                <div class="card-body">
                    <p><strong>Flask:</strong> http://localhost:8000</p>
                    <p><strong>BlackLab Direct:</strong> http://127.0.0.1:8081/blacklab-server/</p>
                    <p><strong>BlackLab via Proxy:</strong> http://localhost:8000/bls/</p>
                    <hr/>
                    <button class="btn btn-sm btn-outline-primary" onclick="checkHealthDirect()">
                        ‚úì Check Direct Health
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="checkHealthProxy()">
                        ‚úì Check Proxy Health
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5>üîó Quick Links</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><a href="/bls/" target="_blank">‚Üí /bls/</a> (via Proxy)</li>
                        <li><a href="/bls/search" target="_blank">‚Üí /bls/search</a> (Search UI)</li>
                        <li><a href="/bls/api" target="_blank">‚Üí /bls/api</a> (REST API)</li>
                        <li><a href="http://127.0.0.1:8081/blacklab-server/" target="_blank">‚Üí Direct Server</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Simple Search Tests -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5>üîé Test Queries (via Proxy)</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted">Basic smoke tests using CQL syntax.</p>
                    <div id="search-results" class="alert alert-info" role="alert" style="display:none;">
                        <span id="search-status"></span>
                    </div>
                    <form id="search-form" onsubmit="return testSearch(event)">
                        <div class="mb-3">
                            <label for="query-type" class="form-label">Query Type:</label>
                            <select id="query-type" class="form-select">
                                <option value="simple-word">Simple Word Match</option>
                                <option value="lemma">Lemma Search</option>
                                <option value="pos">POS Tag Search</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm">Run Query</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Configuration Info -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5>‚öôÔ∏è Configuration</h5>
                </div>
                <div class="card-body">
                    <p><strong>Index Directory:</strong> <code>/data/blacklab_index</code></p>
                    <p><strong>Proxy Upstream:</strong> <code>http://127.0.0.1:8081/blacklab-server</code></p>
                    <p><strong>Format:</strong> TSV with docmeta.jsonl</p>
                    <p><strong>Token Fields:</strong></p>
                    <ul class="small">
                        <li>word, norm, lemma, pos</li>
                        <li>past_type, future_type, tense, mood</li>
                        <li>person, number, aspect</li>
                        <li>tokid, start_ms, end_ms</li>
                        <li>sentence_id, utterance_id, speaker_code</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Response Preview -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5>üìã Response Preview</h5>
                </div>
                <div class="card-body">
                    <pre id="response-preview" style="height: 400px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">
{ "status": "ready", "message": "No query executed yet" }
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
    </div>
</div>

<script>
    // Check Direct Health
    async function checkHealthDirect() {
        try {
            const response = await fetch('http://127.0.0.1:8081/blacklab-server/', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const data = await response.json();
            showResponse('Direct Server OK: ' + JSON.stringify(data, null, 2));
        } catch (e) {
            showResponse('‚ùå Direct Server Error: ' + e.message);
        }
    }

    // Check Proxy Health
    async function checkHealthProxy() {
        try {
            const response = await fetch('/bls/', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const data = await response.json();
            showResponse('Proxy OK: ' + JSON.stringify(data, null, 2));
        } catch (e) {
            showResponse('‚ùå Proxy Error: ' + e.message);
        }
    }

    // Test Search Query
    async function testSearch(event) {
        event.preventDefault();
        const queryType = document.getElementById('query-type').value;
        
        let cqlQuery = '';
        switch (queryType) {
            case 'simple-word':
                cqlQuery = '[word="and"]';
                break;
            case 'lemma':
                cqlQuery = '[lemma="be"]';
                break;
            case 'pos':
                cqlQuery = '[pos="VERB"]';
                break;
            default:
                cqlQuery = '[word="test"]';
        }

        try {
            document.getElementById('search-results').style.display = 'block';
            document.getElementById('search-status').textContent = '‚è≥ Searching...';

            const response = await fetch(`/bls/api/v1/corpus/corapan/search?query=${encodeURIComponent(cqlQuery)}&outputformat=json`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            const data = await response.json();
            showResponse(JSON.stringify(data, null, 2));
            document.getElementById('search-status').textContent = `‚úì Query: ${cqlQuery} (${response.status})`;
        } catch (e) {
            showResponse('‚ùå Query Error: ' + e.message);
            document.getElementById('search-status').textContent = '‚ùå Query failed';
        }
    }

    // Display Response
    function showResponse(content) {
        document.getElementById('response-preview').textContent = content;
    }

    // Load initial info
    window.addEventListener('load', function() {
        showResponse('Debug dashboard ready. Use buttons above to test connectivity.');
    });
</script>
{% endblock %}
