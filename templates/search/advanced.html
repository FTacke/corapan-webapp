{% extends 'base.html' %}

{% block page_title %}Consultar corpus · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- MD3 Core Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}">
<!-- MD3 Components (Base) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/textfields.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/corpus.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/token-chips.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/alerts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/chips.css') }}">
<!-- Material Symbols (MD3-konform) -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<!-- External Libraries (CDN Base Styles BEFORE Project Overrides) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<!-- Project Overrides (AFTER CDN Styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables-theme-lock.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/advanced-search.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/search-ui.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/stats.css') }}"><!-- Material Symbols loaded for help icons -->
{% endblock %}

{% block content %}
<article class="md3-corpus-page">
  <!-- Hero Header -->
  <section class="md3-hero md3-hero--container md3-hero--with-icon" aria-label="Consultar corpus">
    <div class="md3-hero__container">
      <span class="material-symbols-rounded md3-hero__icon" aria-hidden="true">manage_search</span>
      <div class="md3-hero__content">
        <span class="md3-hero__eyebrow">Corpus</span>
        <h1 class="md3-hero__title">Consultar corpus</h1>
        <p class="md3-hero__intro">
          Búsqueda con CQL (Corpus Query Language) vía BlackLab. Secuencias, POS, lemas, filtros por metadatos.
        </p>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="md3-corpus-content">
    <!-- Tab Navigation -->
    <nav class="md3-tabs" role="tablist">
      <button type="button" class="md3-tab md3-tab--active" role="tab" aria-selected="true" data-tab="advanced">Consultar corpus</button>
      <button type="button" class="md3-tab" role="tab" aria-selected="false" data-tab="token">Token</button>
    </nav>
    
    <!-- Advanced Search Container (Tab: Consultar corpus) -->
    <section id="tab-advanced" class="md3-tab-content md3-tab-content--active">
      <!-- ========================================
           SEARCH FORM CARD (MD3 Design)
           Estructura: A-F según especificación
           ======================================== -->
      <form id="advanced-search-form" class="md3-search-card" role="search" aria-label="Consultar corpus con filtros">
          
          <!-- ========================================
               A: BASIS-QUERY
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Consulta simple</h2>
            
            <div class="md3-search-card__query-row">
              <!-- Query Input -->
              <div class="md3-outlined-textfield md3-outlined-textfield--flex">
                <input 
                  type="text" 
                  id="q" 
                  name="q" 
                  class="md3-outlined-textfield__input" 
                  placeholder="  Consulta  de palabras o secuencias"
                  value="{{ request.args.get('q', '') }}"
                  required
                  aria-required="true">
                <label for="q" class="md3-outlined-textfield__label">Consulta</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>

              <!-- Search Type Dropdown -->
              <div class="md3-outlined-textfield md3-outlined-textfield--fixed">
                <select 
                  name="mode" 
                  id="search_type" 
                  class="md3-outlined-textfield__input md3-outlined-textfield__input--select">
                  <option value="forma" {% if request.args.get('search_type') == 'forma' or not request.args.get('search_type') %}selected{% endif %}>Forma</option>
                  <option value="forma_exacta" {% if request.args.get('search_type') == 'forma_exacta' %}selected{% endif %}>Forma exacta</option>
                  <option value="lema" {% if request.args.get('search_type') == 'lema' %}selected{% endif %}>Lema</option>
                </select>
                <label for="search_type" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Tipo</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
               B: METADATEN-FILTER (Facettenleiste)
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Filtros</h2>
            
            <div class="md3-filters-grid">
              <!-- País -->
              <div class="md3-filter-field" data-facet="pais">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">País</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos los países">Todos los países</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <!-- National codes (always visible) -->
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ARG" data-label="ARG">
                      <span>ARG</span>
                    </label>
                    <label class="md3-filter-option md3-filter-option--regional" data-parent="ARG" style="display: none;">
                      <input type="checkbox" name="pais_ui" value="ARG-CBA" data-label="ARG-CBA">
                      <span>  ↳ ARG-CBA</span>
                    </label>
                    <label class="md3-filter-option md3-filter-option--regional" data-parent="ARG" style="display: none;">
                      <input type="checkbox" name="pais_ui" value="ARG-CHU" data-label="ARG-CHU">
                      <span>  ↳ ARG-CHU</span>
                    </label>
                    <label class="md3-filter-option md3-filter-option--regional" data-parent="ARG" style="display: none;">
                      <input type="checkbox" name="pais_ui" value="ARG-SDE" data-label="ARG-SDE">
                      <span>  ↳ ARG-SDE</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="BOL" data-label="BOL">
                      <span>BOL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CHL" data-label="CHL">
                      <span>CHL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="COL" data-label="COL">
                      <span>COL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CRI" data-label="CRI">
                      <span>CRI</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CUB" data-label="CUB">
                      <span>CUB</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ECU" data-label="ECU">
                      <span>ECU</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ESP" data-label="ESP">
                      <span>ESP</span>
                    </label>
                    <label class="md3-filter-option md3-filter-option--regional" data-parent="ESP" style="display: none;">
                      <input type="checkbox" name="pais_ui" value="ESP-CAN" data-label="ESP-CAN">
                      <span>  ↳ ESP-CAN</span>
                    </label>
                    <label class="md3-filter-option md3-filter-option--regional" data-parent="ESP" style="display: none;">
                      <input type="checkbox" name="pais_ui" value="ESP-SEV" data-label="ESP-SEV">
                      <span>  ↳ ESP-SEV</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="USA" data-label="USA">
                      <span>USA</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="GTM" data-label="GTM">
                      <span>GTM</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="HND" data-label="HND">
                      <span>HND</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="MEX" data-label="MEX">
                      <span>MEX</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="NIC" data-label="NIC">
                      <span>NIC</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PAN" data-label="PAN">
                      <span>PAN</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PRY" data-label="PRY">
                      <span>PRY</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PER" data-label="PER">
                      <span>PER</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="DOM" data-label="DOM">
                      <span>DOM</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="SLV" data-label="SLV">
                      <span>SLV</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="URY" data-label="URY">
                      <span>URY</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="VEN" data-label="VEN">
                      <span>VEN</span>
                    </label>
                  </div>
                </div>
                <!-- Hidden select for backend -->
                <select name="country_code" multiple hidden>
                  <!-- National codes -->
                  <option value="ARG" {% if 'ARG' in request.args.getlist('country_code') %}selected{% endif %}>ARG</option>
                  <option value="ARG-CBA" {% if 'ARG-CBA' in request.args.getlist('country_code') %}selected{% endif %}>ARG-CBA</option>
                  <option value="ARG-CHU" {% if 'ARG-CHU' in request.args.getlist('country_code') %}selected{% endif %}>ARG-CHU</option>
                  <option value="ARG-SDE" {% if 'ARG-SDE' in request.args.getlist('country_code') %}selected{% endif %}>ARG-SDE</option>
                  <option value="BOL" {% if 'BOL' in request.args.getlist('country_code') %}selected{% endif %}>BOL</option>
                  <option value="CHL" {% if 'CHL' in request.args.getlist('country_code') %}selected{% endif %}>CHL</option>
                  <option value="COL" {% if 'COL' in request.args.getlist('country_code') %}selected{% endif %}>COL</option>
                  <option value="CRI" {% if 'CRI' in request.args.getlist('country_code') %}selected{% endif %}>CRI</option>
                  <option value="CUB" {% if 'CUB' in request.args.getlist('country_code') %}selected{% endif %}>CUB</option>
                  <option value="ECU" {% if 'ECU' in request.args.getlist('country_code') %}selected{% endif %}>ECU</option>
                  <option value="ESP" {% if 'ESP' in request.args.getlist('country_code') %}selected{% endif %}>ESP</option>
                  <option value="ESP-CAN" {% if 'ESP-CAN' in request.args.getlist('country_code') %}selected{% endif %}>ESP-CAN</option>
                  <option value="ESP-SEV" {% if 'ESP-SEV' in request.args.getlist('country_code') %}selected{% endif %}>ESP-SEV</option>
                  <option value="USA" {% if 'USA' in request.args.getlist('country_code') %}selected{% endif %}>USA</option>
                  <option value="GTM" {% if 'GTM' in request.args.getlist('country_code') %}selected{% endif %}>GTM</option>
                  <option value="HND" {% if 'HND' in request.args.getlist('country_code') %}selected{% endif %}>HND</option>
                  <option value="MEX" {% if 'MEX' in request.args.getlist('country_code') %}selected{% endif %}>MEX</option>
                  <option value="NIC" {% if 'NIC' in request.args.getlist('country_code') %}selected{% endif %}>NIC</option>
                  <option value="PAN" {% if 'PAN' in request.args.getlist('country_code') %}selected{% endif %}>PAN</option>
                  <option value="PRY" {% if 'PRY' in request.args.getlist('country_code') %}selected{% endif %}>PRY</option>
                  <option value="PER" {% if 'PER' in request.args.getlist('country_code') %}selected{% endif %}>PER</option>
                  <option value="DOM" {% if 'DOM' in request.args.getlist('country_code') %}selected{% endif %}>DOM</option>
                  <option value="SLV" {% if 'SLV' in request.args.getlist('country_code') %}selected{% endif %}>SLV</option>
                  <option value="URY" {% if 'URY' in request.args.getlist('country_code') %}selected{% endif %}>URY</option>
                  <option value="VEN" {% if 'VEN' in request.args.getlist('country_code') %}selected{% endif %}>VEN</option>
                </select>
              </div>

              <!-- Hablante -->
              <div class="md3-filter-field" data-facet="hablante">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Hablante</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="hablante_ui" value="pro" data-label="Profesional">
                      <span>Profesional</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="hablante_ui" value="otro" data-label="Otro">
                      <span>Otro</span>
                    </label>
                  </div>
                </div>
                <select name="speaker_type" multiple hidden>
                  <option value="pro" {% if 'pro' in request.args.getlist('speaker_type') %}selected{% endif %}>Profesional</option>
                  <option value="otro" {% if 'otro' in request.args.getlist('speaker_type') %}selected{% endif %}>Otro</option>
                </select>
              </div>

              <!-- Sexo -->
              <div class="md3-filter-field" data-facet="sexo">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Sexo</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="sexo_ui" value="m" data-label="Masculino">
                      <span>Masculino</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="sexo_ui" value="f" data-label="Femenino">
                      <span>Femenino</span>
                    </label>
                  </div>
                </div>
                <select name="sex" multiple hidden>
                  <option value="m" {% if 'm' in request.args.getlist('sex') %}selected{% endif %}>Masculino</option>
                  <option value="f" {% if 'f' in request.args.getlist('sex') %}selected{% endif %}>Femenino</option>
                </select>
              </div>

              <!-- Modo -->
              <div class="md3-filter-field" data-facet="modo">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Modo</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="pre" data-label="Anuncio">
                      <span>Anuncio</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="lectura" data-label="Lectura">
                      <span>Lectura</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="libre" data-label="Habla libre">
                      <span>Habla libre</span>
                    </label>
                  </div>
                </div>
                <select name="speech_mode" multiple hidden>
                  <option value="pre" {% if 'pre' in request.args.getlist('speech_mode') %}selected{% endif %}>Anuncio</option>
                  <option value="lectura" {% if 'lectura' in request.args.getlist('speech_mode') %}selected{% endif %}>Lectura</option>
                  <option value="libre" {% if 'libre' in request.args.getlist('speech_mode') %}selected{% endif %}>Habla libre</option>
                </select>
              </div>

              <!-- Discurso -->
              <div class="md3-filter-field" data-facet="discurso">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Discurso</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="general" data-label="General">
                      <span>General</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="tiempo" data-label="Tiempo">
                      <span>Tiempo</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="tránsito" data-label="Tránsito">
                      <span>Tránsito</span>
                    </label>
                  </div>
                </div>
                <select name="discourse" multiple hidden>
                  <option value="general" {% if 'general' in request.args.getlist('discourse') %}selected{% endif %}>General</option>
                  <option value="tiempo" {% if 'tiempo' in request.args.getlist('discourse') %}selected{% endif %}>Tiempo</option>
                  <option value="tránsito" {% if 'tránsito' in request.args.getlist('discourse') %}selected{% endif %}>Tránsito</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ========================================
               ACTIVE FILTERS CHIP BAR
               ======================================== -->
          <div id="active-filters-bar" class="md3-active-filters" hidden>
            <div class="md3-active-filters__label">Filtros activos:</div>
            <div id="active-filters-chips" class="md3-active-filters__chips">
              <!-- Chips will be inserted here by JS -->
            </div>
          </div>

          <!-- ========================================
               C: OPTIONEN (Checkboxen)
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Opciones</h2>
            
            <div class="md3-options-row">
              <label class="md3-checkbox-container">
                <input type="checkbox" id="include-regional" name="include_regional" value="1" {% if request.args.get('include_regional') %}checked{% endif %}>
                <span class="md3-checkbox">
                  <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                    <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                  </svg>
                </span>
                <span class="md3-checkbox__label">Incluir emisoras regionales</span>
              </label>
              
              <label class="md3-checkbox-container">
                <input type="checkbox" id="ignore-accents" name="ignore_accents" value="1" {% if request.args.get('ignore_accents') %}checked{% endif %}>
                <span class="md3-checkbox">
                  <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                    <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                  </svg>
                </span>
                <span class="md3-checkbox__label">Ignorar acentos/mayúsculas</span>
              </label>
            </div>
          </div>

          <!-- ========================================
               D: TOGGLE FÜR ADVANCED MODE
               ======================================== -->
          <div class="md3-search-card__section md3-search-card__section--toggle">
            <button type="button" id="advanced-mode-toggle" class="md3-button md3-button--outlined" aria-expanded="false" aria-controls="expert-area">
              <span class="material-symbols-rounded">tune</span>
              <span>Modo avanzado (CQL)</span>
              <span class="material-symbols-rounded md3-button__icon--end" id="advanced-mode-icon">expand_more</span>
            </button>
          </div>

          <!-- ========================================
               E: EXPERTENBEREICH (nur bei Modo avanzado)
               ======================================== -->
          <div id="expert-area" class="md3-expert-area" hidden>
            
            <!-- E1: PATTERN BUILDER -->
            <div class="md3-expert-section" style="overflow: visible;">
              <div class="md3-expert-header">
                <h3 class="md3-expert-section__title">Patrones de palabras (CQL)</h3>
                        <!-- Help tooltip deliberately removed — shows as dialog only via (Guía y prompt) link -->
              </div>
              <p class="md3-expert-section__description">
                Construye patrones como 'verbo + sustantivo' paso a paso sin escribir CQL a mano.
              </p>

              <div id="pattern-builder" class="md3-pattern-builder">
                <!-- Token rows will be inserted here -->
                <div class="md3-pattern-builder__tokens" id="pattern-tokens">
                  <!-- Initial token row -->
                  <div class="md3-token-row" data-token-index="0">
                    <div class="md3-token-row__number">Token 1</div>
                    
                    <div class="md3-outlined-textfield md3-outlined-textfield--compact">
                      <select class="md3-outlined-textfield__input md3-outlined-textfield__input--select token-field-select">
                        <option value="forma">Forma</option>
                        <option value="lema">Lema</option>
                        <option value="pos">Categoría gramatical (POS)</option>
                      </select>
                      <label class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Campo</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <div class="md3-outlined-textfield md3-outlined-textfield--compact">
                      <select class="md3-outlined-textfield__input md3-outlined-textfield__input--select token-match-select">
                        <option value="exact">es exactamente</option>
                        <option value="contains">contiene</option>
                        <option value="starts">empieza por</option>
                        <option value="ends">termina en</option>
                      </select>
                      <label class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Tipo</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <div class="md3-outlined-textfield md3-outlined-textfield--flex">
                      <input 
                        type="text" 
                        class="md3-outlined-textfield__input token-value-input" 
                        placeholder=" ">
                      <label class="md3-outlined-textfield__label">Valor</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <button type="button" class="md3-icon-button token-remove-btn" title="Eliminar" disabled>
                      <span class="material-symbols-rounded">close</span>
                    </button>
                  </div>
                </div>

                <button type="button" id="add-token-btn" class="md3-button md3-button--outlined">
                  <span class="material-symbols-rounded">add</span>
                  <span>Añadir palabra siguiente</span>
                </button>

                <!-- Distance Rule -->
                <div class="md3-distance-rule">
                  <h4 class="md3-distance-rule__title">Distancia entre palabras</h4>
                  
                  <label class="md3-radio-container">
                    <input type="radio" name="distance_type" value="consecutive" checked>
                    <span class="md3-radio"></span>
                    <span class="md3-radio__label">Justo seguidas</span>
                  </label>

                  <label class="md3-radio-container">
                    <input type="radio" name="distance_type" value="gap">
                    <span class="md3-radio"></span>
                    <span class="md3-radio__label">Hasta N palabras entre medias</span>
                  </label>

                  <div id="distance-number-field" class="md3-outlined-textfield md3-outlined-textfield--compact" hidden>
                    <input 
                      type="number" 
                      id="distance-max" 
                      name="distance_max" 
                      class="md3-outlined-textfield__input" 
                      min="0" 
                      max="10" 
                      value="1"
                      placeholder=" ">
                    <label for="distance-max" class="md3-outlined-textfield__label">Número máximo de palabras entre medias</label>
                    <div class="md3-outlined-textfield__outline">
                      <div class="md3-outlined-textfield__outline-start"></div>
                      <div class="md3-outlined-textfield__outline-notch"></div>
                      <div class="md3-outlined-textfield__outline-end"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- E2: CQL PREVIEW -->
            <div class="md3-expert-section">
              <h3 class="md3-expert-section__title">Consulta CQL</h3>
              
              <div class="md3-cql-preview">
                <textarea 
                  id="cql-preview" 
                  class="md3-cql-textarea" 
                  rows="4" 
                  readonly
                  aria-label="Vista previa de la consulta CQL"></textarea>
                
                <label class="md3-checkbox-container">
                  <input type="checkbox" id="allow-manual-edit" name="allow_manual_edit">
                  <span class="md3-checkbox">
                    <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                      <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                    </svg>
                  </span>
                  <span class="md3-checkbox__label">Permitir editar manualmente <a href="#" id="cql-guide-link" class="md3-link md3-link--inline">(Guía y prompt)</a></span>
                </label>

                <div id="cql-warning" class="md3-cql-warning" hidden>
                  <span class="material-symbols-rounded">warning</span>
                  <span>Si editas la consulta CQL a mano, la interfaz de patrones puede dejar de reflejar todos los detalles.</span>
                </div>
              </div>
            </div>

            <!-- E3: PLANTILLAS RÁPIDAS -->
            <div class="md3-expert-section">
              <h3 class="md3-expert-section__title">Plantillas frecuentes</h3>
              
              <div class="md3-templates">
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="verb-noun">
                  Verbo + sustantivo
                </button>
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="adj-noun">
                  Adjetivo + sustantivo
                </button>
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="same-lemma">
                  Dos palabras con el mismo lema
                </button>
              </div>
            </div>
          </div>

          <!-- ========================================
               F: FORMULAR-FOOTER
               ======================================== -->
          <div class="md3-search-card__footer">
            <button type="button" id="reset-form-btn" class="md3-button md3-button--outlined">
              <span class="material-symbols-rounded">restart_alt</span>
              <span>Restablecer</span>
            </button>
            <button type="submit" class="md3-button md3-button--filled">
              <span class="material-symbols-rounded">search</span>
              <span>Buscar</span>
            </button>
          </div>

        </form>

        <!-- CQL Guide Modal (MD3 overlay) -->
        <div id="cql-guide-overlay" class="md3-dialog-overlay" aria-hidden="true">
          <div id="cql-guide-dialog" class="md3-dialog md3-dialog--large" role="dialog" aria-modal="true" aria-labelledby="cql-guide-title" tabindex="-1">
            <div class="md3-dialog__container">
              <div class="md3-dialog__header">
                <span class="material-symbols-rounded md3-dialog__icon">info</span>
                <h2 class="md3-dialog__title" id="cql-guide-title">Ayuda CQL</h2>
              </div>
              <div class="md3-dialog__content">
                <p class="md3-body-medium md3-text-variant">
                  Sobre la sintaxis de Blacklab-CQL véase <a href="https://inl.github.io/BlackLab/corpus-query-language.html" target="_blank" rel="noopener noreferrer" class="md3-link">aquí</a>.
                </p>
                <div class="md3-prompt-container">
                  <p class="md3-prompt-title">Prompt sugerido para generar consultas CQL en CORAPAN (BlackLab)</p>
                  <p class="md3-prompt-subtitle">Copia y pega este prompt en el modelo de IA generativa y luego añade tu descripción al final:</p>
                  <div class="md3-code-block md3-full-width">
                    <pre class="highlight"><code id="cql-guide-prompt" class="language-plaintext">Actúa como generador de consultas CQL para un corpus de español hablado llamado CORAPAN, indexado en BlackLab.

El corpus está anotado con los siguientes atributos a nivel de token (dentro de corchetes `[...]` en CQL):

* `word`  → forma tal como aparece en la transcripción
* `norm`  → forma normalizada (por ejemplo, en minúsculas)
* `lemma` → lema
* `pos`   → categoría gramatical (UD POS: NOUN, VERB, ADJ, ADV, PRON, DET, ADP, SCONJ, CCONJ, PART, AUX, etc.)
* `tense` → tiempo verbal (por ejemplo: `Pres`, `Past`, `Fut`)
* `mood`  → modo verbal (por ejemplo: `Ind`, `Subj`, `Imp`)
* `person` → persona gramatical (`1`, `2`, `3`)
* `number` → número gramatical (`Sing`, `Plur`)
* `aspect` → aspecto verbal (si está presente)
* `past_type` → tipo de pasado (si está anotado)
* `future_type` → tipo de futuro (si está anotado)
* `tokid` → identificador único de cada token

Además, puedes usar metadatos de documento/segmento con BlackLab (por ejemplo mediante `within`), como:

* `country_code` → código de país/variedad (por ejemplo `ARG`, `ESP`, `ARG-CBA`, `ESP-SEV`, etc.)
* `file_id`      → identificador de archivo
* `date`         → fecha de la grabación/transcripción
* `radio`        → indica si el texto procede de radio sí/no (según cómo esté codificado)
* `city`         → ciudad (si está disponible)
* `sentence_id`, `utterance_id` → identificadores de oración y enunciado

Tu tarea:

1. Léeme la descripción en lenguaje natural que te daré.
2. Genera **solo** una consulta CQL válida para BlackLab, sin explicaciones ni comentarios.
3. Usa exclusivamente los atributos y metadatos listados arriba.
4. Representa las palabras y rasgos morfológicos con patrones como:

   * `[lemma="hablar"]`
   * `[pos="VERB" & tense="Pres" & person="1" & number="Sing"]`
   * `[pos="ADJ"][pos="NOUN"]` para un adjetivo seguido de un sustantivo.
5. Si menciono restricciones de variedad, origen o tipo de texto, exprésalas con metadatos, por ejemplo:

   * `within <country_code="ARG"> [...]`
   * `within <radio="yes"> [...]` (ajusta el valor según la codificación real).
6. Usa siempre comillas dobles `"..."` y la sintaxis CQL estándar de BlackLab.
7. Si la descripción es ambigua, elige la interpretación más común en lingüística hispánica, pero **no inventes** atributos que no existen en la lista.

Ahora convierte la siguiente descripción en una consulta CQL precisa para CORAPAN:

«[ESCRIBE AQUÍ TU DESCRIPCIÓN EN ESPAÑOL]»</code></pre>
                  </div>
                </div>
              </div>
              <div class="md3-dialog__actions">
                <button type="button" class="md3-button md3-button--text md3-dialog__close" id="cql-guide-close">Cerrar</button>
                <button type="button" class="md3-button md3-button--filled" id="cql-guide-copy">
                  <span class="material-symbols-rounded">content_copy</span>
                  Copiar prompt
                </button>
              </div>
            </div>
          </div>
        </div>



      <!-- ========================================
           SUB-TABS: RESULTADOS | ESTADÍSTICAS
           Hidden by default, shown after successful search
           ======================================== -->
      <div id="search-sub-tabs" role="tablist" class="md3-stats-tabs" style="margin-top: 1.5rem; display: none;">
        <button type="button" role="tab" id="tab-resultados" class="md3-stats-tab md3-stats-tab--active" data-view="results" aria-controls="panel-resultados" aria-selected="true">
          <span class="material-symbols-rounded" aria-hidden="true">table</span>
          <span>Resultados</span>
        </button>
        <button type="button" role="tab" id="tab-estadisticas" class="md3-stats-tab" data-view="stats" aria-controls="panel-estadisticas" aria-selected="false">
          <span class="material-symbols-rounded" aria-hidden="true">bar_chart</span>
          <span>Estadísticas</span>
        </button>
      </div>

      <!-- Results Section -->
      <div id="panel-resultados" role="tabpanel" aria-labelledby="tab-resultados" class="md3-view-content md3-view-content--active">
        <!-- Error banners will be inserted here -->
        <div id="results-section"></div>
        
        <div id="adv-summary" 
          class="md3-advanced__summary" 
          role="status" 
          aria-live="polite" 
          aria-atomic="true"
          tabindex="-1"
          hidden>
          <!-- Content loaded via JS -->
        </div>

        <!-- DataTables Container (hidden until search performed) -->
        <div id="datatable-container" class="md3-advanced__tablewrap md3-corpus-table-container" style="display: none;">
          <table id="advanced-table" class="md3-corpus-table" role="grid">
            <caption class="sr-only">
              Resultados de búsqueda avanzada. 
              Tabla con contexto izquierdo, palabra coincidente, contexto derecho, audio y metadatos.
            </caption>
            <thead>
              <tr role="row">
                <th scope="col" role="columnheader">#</th>
                <th scope="col" role="columnheader">Ctx.←</th>
                <th scope="col" role="columnheader">Resultado</th>
                <th scope="col" role="columnheader">Ctx.→</th>
                <th scope="col" role="columnheader">Audio</th>
                <th scope="col" role="columnheader">País</th>
                <th scope="col" role="columnheader">Hablante</th>
                <th scope="col" role="columnheader">Sexo</th>
                <th scope="col" role="columnheader">Modo</th>
                <th scope="col" role="columnheader">Discurso</th>
                <th scope="col" role="columnheader">Token-ID</th>
                <th scope="col" role="columnheader">Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rendered by DataTables -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Panel -->
      <div id="panel-estadisticas" role="tabpanel" aria-labelledby="tab-estadisticas" class="md3-view-content" hidden>
        <section class="md3-stats-section">
          <header class="md3-stats-header">
            <div class="md3-stats-filter">
              <label for="stats-country-filter" class="md3-stats-filter-label">Filtrar por país:</label>
              <select id="stats-country-filter" class="md3-stats-filter-select">
                <option value="">Todos los países</option>
              </select>
            </div>
            <p id="stats-total" class="md3-body-medium" style="margin: 0.5rem 0 0 0; color: var(--md-sys-color-on-surface-variant);">
              Tokens coincidentes: <strong style="color: var(--md-sys-color-primary);">—</strong>
            </p>
          </header>

          <div id="stats-grid" class="md3-stats-charts-grid">
            <!-- País -->
            <article class="card card-elevated" data-chart="by_country">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">País</h3>
                  <p class="md3-body-small" style="color: var(--md-sys-color-on-surface-variant); margin: 0;" data-meta="by_country">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="country">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-country" aria-label="Distribución por país"></div>
              </div>
            </article>

            <!-- Tipo de hablante -->
            <article class="card card-elevated" data-chart="by_speaker_type">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Tipo de hablante</h3>
                  <p class="md3-body-small" style="color: var(--md-sys-color-on-surface-variant); margin: 0;" data-meta="by_speaker_type">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="speaker">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-speaker" aria-label="Distribución por tipo de hablante"></div>
              </div>
            </article>

            <!-- Sexo -->
            <article class="card card-elevated" data-chart="by_sexo">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Sexo</h3>
                  <p class="md3-body-small" style="color: var(--md-sys-color-on-surface-variant); margin: 0;" data-meta="by_sexo">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="sexo">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-sexo" aria-label="Distribución por sexo"></div>
              </div>
            </article>

            <!-- Registro -->
            <article class="card card-elevated" data-chart="by_modo">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Modo de habla</h3>
                  <p class="md3-body-small" style="color: var(--md-sys-color-on-surface-variant); margin: 0;" data-meta="by_modo">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="modo">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-modo" aria-label="Distribución por modo de habla"></div>
              </div>
            </article>

            <!-- Discurso -->
            <article class="card card-elevated" data-chart="by_discourse">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Discurso</h3>
                  <p class="md3-body-small" style="color: var(--md-sys-color-on-surface-variant); margin: 0;" data-meta="by_discourse">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="discourse">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-discourse" aria-label="Distribución por discurso"></div>
              </div>
            </article>
          </div>
        </section>
      </div>
    </section>

    <!-- Token Search Container (Tab: Token) -->
    <section id="tab-token" class="md3-tab-content">
      <!-- Token Search Form (MD3 Search Card) -->
      <form id="token-search-form" class="md3-search-card" role="search" aria-label="Buscar por Token-IDs">
        
        <!-- Token Input Section -->
        <div class="md3-search-card__section">
          <h2 class="md3-search-card__heading">Buscar por Token-IDs</h2>
          
          <!-- Input Row -->
          <div class="md3-search-card__query-row">
            <div class="md3-outlined-textfield md3-outlined-textfield--flex">
              <input 
                type="text" 
                id="tokid-input" 
                class="md3-outlined-textfield__input"
                placeholder=" "
                autocomplete="off">
              <label for="tokid-input" class="md3-outlined-textfield__label">Token-IDs</label>
              <div class="md3-outlined-textfield__outline">
                <div class="md3-outlined-textfield__outline-start"></div>
                <div class="md3-outlined-textfield__outline-notch"></div>
                <div class="md3-outlined-textfield__outline-end"></div>
              </div>
            </div>
            
            <button type="button" class="md3-button-filled" id="tokid-add-btn">
              <span class="material-symbols-rounded">add</span>
              <span>Añadir</span>
            </button>
          </div>
          
          <!-- Helper Text: token count moved into chip container -->
          
          <!-- Chip Container (active-filters style) -->
          <div id="tokid-chip-container" class="tokid-chip-container md3-active-filters" aria-live="polite">
            <span id="tokid-count" class="md3-active-filters__label tokid-count">0 IDs</span>
            <div id="tokid-chip-items" class="md3-active-filters__chips"></div>
          </div>
        </div>

        <!-- Actions Footer -->
        <div class="md3-search-card__footer">
          <button type="button" id="clear-tokens-btn" class="md3-button md3-button--outlined">
            <span class="material-symbols-rounded">delete</span>
            <span>Limpiar todo</span>
          </button>
          <button type="button" id="token-search-btn" class="md3-button md3-button--filled">
            <span class="material-symbols-rounded">table_view</span>
            <span>Visualizar</span>
          </button>
        </div>
      </form>
      
      <!-- Token Results Section -->
      <section id="token-results" class="md3-view-content" style="display: none; margin-top: 2rem;">
        <!-- Token Sub-Tabs (Resultados | Estadísticas) -->
        <div id="token-sub-tabs" role="tablist" class="md3-token-stats-tabs md3-stats-tabs" style="margin-top: 0.5rem; display: flex;">
          <button type="button" role="tab" id="token-tab-resultados" class="md3-token-stats-tab md3-stats-tab md3-stats-tab--active" data-view="results" aria-controls="token-panel-resultados" aria-selected="true">
            <span class="material-symbols-rounded" aria-hidden="true">table</span>
            <span>Resultados</span>
          </button>
        </div>

        <div id="token-panel-resultados" role="tabpanel" aria-labelledby="token-tab-resultados" class="md3-view-content md3-view-content--active">

        
        <!-- DataTable Container -->
        <div class="md3-corpus-table-container">
          <table id="token-results-table" class="md3-corpus-table" style="width:100%">
            <thead>
              <tr>
                <th>#</th>
                <th>Ctx.←</th>
                <th>Resultado</th>
                <th>Ctx.→</th>
                <th>Audio</th>
                <th>País</th>
                <th>Hablante</th>
                <th>Sexo</th>
                <th>Modo</th>
                <th>Discurso</th>
                <th>Token-ID</th>
                <th>Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- DataTables (Server-Side) will populate this dynamically -->
            </tbody>
          </table>
        </div>
        </div>

        <div id="token-panel-estadisticas" role="tabpanel" aria-labelledby="token-tab-estadisticas" class="md3-view-content" hidden>
          <div class="md3-body-medium" style="padding: 1rem;">
            <div id="stats-grid" class="md3-stats-grid">
              <div id="chart-country"></div>
              <div id="chart-speaker"></div>
              <div id="chart-sexo"></div>
              <div id="chart-modo"></div>
              <div id="chart-discourse"></div>
              <div id="chart-radio"></div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </section>
</article>

<!-- Scripts in dependency order -->
<script src="{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}" defer></script>
<!-- DataTables Buttons Extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
<script src="{{ url_for('static', filename='vendor/htmx-1.9.10.min.js') }}" defer></script>
<!-- ECharts for statistics -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
<!-- Tab Switching Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.md3-tabs [data-tab]');
    const tabContents = document.querySelectorAll('.md3-tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => {
          btn.classList.remove('md3-tab--active');
          btn.setAttribute('aria-selected', 'false');
        });
        tabContents.forEach(content => {
          content.classList.remove('md3-tab-content--active');
        });
        
        // Add active class to clicked button and corresponding content
        this.classList.add('md3-tab--active');
        this.setAttribute('aria-selected', 'true');
        const targetContent = document.getElementById('tab-' + tabName);
        if (targetContent) {
          targetContent.classList.add('md3-tab-content--active');
        }
      });
    });
  });
</script>
<!-- App modules -->
<script src="{{ url_for('static', filename='js/modules/search/config.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/filters.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/patternBuilder.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/searchUI.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/advanced/initTable.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/stats/renderBar.js') }}" type="module"></script>
<!-- Token Tab Module -->
<script type="module" src="{{ url_for('static', filename='js/modules/search/token-tab.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/modules/advanced/index.js') }}"></script>
<script type="module">
  import { initStatsTabAdvanced, cleanupStats } from '{{ url_for("static", filename="js/modules/stats/initStatsTabAdvanced.js") }}';
  
  // Initialize stats tab when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initStatsTabAdvanced);
  } else {
    initStatsTabAdvanced();
  }
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', cleanupStats);
</script>

<script>
  // Tooltip functions removed from Advanced Search template (use player page globals instead)
</script>

<script>
  // Ensure that any tooltips are hidden on initial load to avoid visual flash
  // No advanced page-specific tooltips to initialize
</script>

<!-- Regional checkbox toggle logic -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const includeRegionalCheckbox = document.getElementById('include-regional');
    const regionalOptions = document.querySelectorAll('.md3-filter-option--regional');
    
    function toggleRegionalOptions() {
      const isChecked = includeRegionalCheckbox?.checked || false;
      regionalOptions.forEach(option => {
        option.style.display = isChecked ? '' : 'none';
        // Uncheck regional options when hiding them
        if (!isChecked) {
          const checkbox = option.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.checked = false;
          }
        }
      });
    }
    
    // Initial state
    if (includeRegionalCheckbox) {
      toggleRegionalOptions();
      includeRegionalCheckbox.addEventListener('change', toggleRegionalOptions);
    }
    
    // Re-bind after HTMX swaps
    document.addEventListener('htmx:afterSwap', function() {
      const checkbox = document.getElementById('include-regional');
      const regionals = document.querySelectorAll('.md3-filter-option--regional');
      if (checkbox && regionals.length > 0) {
        toggleRegionalOptions();
        checkbox.removeEventListener('change', toggleRegionalOptions);
        checkbox.addEventListener('change', toggleRegionalOptions);
      }
    });
  });
</script>
{% endblock %}

{# Styles moved to static/css/md3/components/advanced-search.css and md3/components/editor-edit.css #}
