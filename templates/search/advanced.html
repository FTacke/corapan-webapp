{% extends 'base.html' %}

{% block page_title %}Consultar corpus · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- MD3 Core Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}">
<!-- MD3 Components (Base) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/textfields.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/corpus.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/token-chips.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/alerts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/chips.css') }}">
<!-- Material Symbols (MD3-konform) -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<!-- External Libraries (CDN Base Styles BEFORE Project Overrides) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<!-- Project Overrides (AFTER CDN Styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables-theme-lock.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/advanced-search.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/search-ui.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/stats.css') }}"><!-- Material Symbols loaded for help icons -->
{% endblock %}

{% block content %}
<article class="md3-corpus-page">
  <!-- Hero Header -->
  <section class="md3-hero md3-hero--container md3-hero--with-icon" aria-label="Consultar corpus">
    <div class="md3-hero__container">
      <span class="material-symbols-rounded md3-hero__icon" aria-hidden="true">manage_search</span>
      <div class="md3-hero__content">
        <span class="md3-hero__eyebrow">Corpus</span>
        <h1 class="md3-hero__title">Consultar corpus</h1>
        <p class="md3-hero__intro">
          Búsqueda con CQL (Corpus Query Language) vía BlackLab. Secuencias, POS, lemas, filtros por metadatos.
        </p>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="md3-corpus-content">
    <!-- Tab Navigation -->
    <nav class="md3-tabs" role="tablist">
      <button type="button" class="md3-tab md3-tab--active" role="tab" aria-selected="true" data-tab="simple">Consulta simple</button>
      <button type="button" class="md3-tab" role="tab" aria-selected="false" data-tab="advanced">Modo avanzado (CQL)</button>
      <button type="button" class="md3-tab" role="tab" aria-selected="false" data-tab="token">Token</button>
    </nav>
    
    <!-- TAB: CONSULTA SIMPLE -->
    <section id="tab-simple" class="md3-tab-content md3-tab-content--active">
      <form id="form-simple" class="md3-search-card" role="search" aria-label="Consulta simple">
          <input type="hidden" name="mode" value="simple">
          
          <!-- A: QUERY -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Consulta simple</h2>
            <div class="md3-search-card__query-row">
              <div class="md3-outlined-textfield md3-outlined-textfield--flex">
                <input type="text" id="q" name="q" class="md3-outlined-textfield__input" placeholder=" Consulta" value="{{ request.args.get('q', '') }}">
                <label for="q" class="md3-outlined-textfield__label">Consulta</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>
              <div class="md3-outlined-textfield md3-outlined-textfield--fixed">
                <select name="search_type" id="search_type_simple" class="md3-outlined-textfield__input md3-outlined-textfield__input--select">
                  <option value="forma">Forma</option>
                  <option value="forma_exacta">Forma exacta</option>
                  <option value="lema">Lema</option>
                </select>
                <label for="search_type_simple" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Tipo</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- B: FILTERS (Simple) -->
          {% with suffix='-simple' %}
          {% include 'search/partials/filters_block.html' %}
          {% endwith %}

          <!-- Active Filters Bar (Simple) -->
          <div id="active-filters-bar-simple" class="md3-active-filters" hidden>
            <div class="md3-active-filters__label">Filtros activos:</div>
            <div id="active-filters-chips-simple" class="md3-active-filters__chips"></div>
          </div>

          <!-- C: OPTIONS (Simple) -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Opciones</h2>
            <div class="md3-options-row">
              <label class="md3-checkbox-container">
                <input type="checkbox" id="include-regional-simple" name="include_regional" value="1">
                <span class="md3-checkbox"><svg class="md3-checkbox__checkmark" viewBox="0 0 18 18"><path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path></svg></span>
                <span class="md3-checkbox__label">Incluir emisoras regionales</span>
              </label>
              <label class="md3-checkbox-container">
                <input type="checkbox" id="ignore-accents-simple" name="ignore_accents" value="1">
                <span class="md3-checkbox"><svg class="md3-checkbox__checkmark" viewBox="0 0 18 18"><path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path></svg></span>
                <span class="md3-checkbox__label">Ignorar acentos/mayúsculas</span>
              </label>
            </div>
          </div>

          <!-- F: FOOTER -->
          <div class="md3-search-card__footer">
            <button type="button" class="md3-button md3-button--outlined reset-btn">
              <span class="material-symbols-rounded">restart_alt</span>
              <span>Restablecer</span>
            </button>
            <button type="submit" class="md3-button md3-button--filled">
              <span class="material-symbols-rounded">search</span>
              <span>Buscar</span>
            </button>
          </div>
      </form>
    </section>

    <!-- TAB: MODO AVANZADO -->
    <section id="tab-advanced" class="md3-tab-content">
      <form id="form-advanced" class="md3-search-card" role="search" aria-label="Modo avanzado">
          <input type="hidden" name="mode" value="advanced">

          <!-- E1: PATTERN BUILDER -->
          <div class="md3-expert-section overflow-visible">
              <div class="md3-expert-header">
                <h2 class="md3-expert-section__title">Modo avanzado (CQL)</h2>
              </div>
              
              <!-- Pattern Builder Container -->
              <div id="cql-builder-container" class="md3-pattern-builder">
                  <!-- Token rows will be injected here -->
              </div>

              <div class="md3-pattern-actions mt-4">
                  <button type="button" id="add-token-btn" class="md3-button md3-button--outlined">
                      <span class="material-symbols-rounded">add</span>
                      <span>Añadir palabra</span>
                  </button>
              </div>
          </div>

          <!-- E2: CQL PREVIEW -->
            <div class="md3-expert-section">
              <hr class="md3-divider" />
              <h3 class="md3-expert-section__title">Consulta CQL</h3>
              <div class="md3-cql-preview">
                  <div class="md3-outlined-textfield md3-outlined-textfield--textarea">
                    <textarea id="cql_query" name="cql_query" class="md3-outlined-textfield__input" rows="4" readonly>{{ request.args.get('cql_query', '') }}</textarea>
                    <label for="cql_query" class="md3-outlined-textfield__label">Consulta CQL</label>
                    <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                    </div>
                  </div>
                  
                      <label class="md3-checkbox-container mt-2">
                        <input type="checkbox" id="cql_manual_edit" name="cql_manual_edit">
                        <span class="md3-checkbox"><svg class="md3-checkbox__checkmark" viewBox="0 0 18 18"><path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path></svg></span>
                        <span class="md3-checkbox__label">Permitir editar manualmente <a href="#" id="cql-guide-link" class="md3-link md3-link--inline">(Cómo hacerlo)</a></span>
                      </label>

                      <div id="cql-warning" class="md3-cql-warning" hidden>
                      <span class="material-symbols-rounded">warning</span>
                      <span>La consulta CQL ha sido editada manualmente. El constructor no la sobrescribirá.</span>
                    </div>

                    <!-- guide link restored into checkbox label -->
              </div>
          </div>

          <!-- B: FILTERS (Advanced) -->
          <hr class="md3-divider" />
          {% with suffix='-advanced' %}
          {% include 'search/partials/filters_block.html' %}
          {% endwith %}

          <!-- Active Filters Bar (Advanced) -->
          <div id="active-filters-bar-advanced" class="md3-active-filters" hidden>
            <div class="md3-active-filters__label">Filtros activos:</div>
            <div id="active-filters-chips-advanced" class="md3-active-filters__chips"></div>
          </div>

          <!-- C: OPTIONS (Advanced) -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Opciones</h2>
            <div class="md3-options-row">
              <label class="md3-checkbox-container">
                <input type="checkbox" id="include-regional-advanced" name="include_regional" value="1">
                <span class="md3-checkbox"><svg class="md3-checkbox__checkmark" viewBox="0 0 18 18"><path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path></svg></span>
                <span class="md3-checkbox__label">Incluir emisoras regionales</span>
              </label>
              <label class="md3-checkbox-container">
                <input type="checkbox" id="ignore-accents-advanced" name="ignore_accents" value="1">
                <span class="md3-checkbox"><svg class="md3-checkbox__checkmark" viewBox="0 0 18 18"><path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path></svg></span>
                <span class="md3-checkbox__label">Ignorar acentos/mayúsculas</span>
              </label>
            </div>
          </div>

          <!-- F: FOOTER -->
          <div class="md3-search-card__footer">
            <button type="button" class="md3-button md3-button--outlined reset-btn">
              <span class="material-symbols-rounded">restart_alt</span>
              <span>Restablecer</span>
            </button>
            <button type="submit" class="md3-button md3-button--filled">
              <span class="material-symbols-rounded">search</span>
              <span>Buscar</span>
            </button>
          </div>
      </form>
    </section>

        <!-- CQL Guide Modal (MD3 overlay) -->
        <div id="cql-guide-overlay" class="md3-dialog-overlay" aria-hidden="true">
          <div id="cql-guide-dialog" class="md3-dialog md3-dialog--large" role="dialog" aria-modal="true" aria-labelledby="cql-guide-title" tabindex="-1">
            <div class="md3-dialog__container">
              <div class="md3-dialog__header">
                <span class="material-symbols-rounded md3-dialog__icon">info</span>
                <h2 class="md3-dialog__title" id="cql-guide-title">Ayuda CQL</h2>
              </div>
              <div class="md3-dialog__content">
                <p class="md3-body-medium md3-text-variant">
                  Sobre la sintaxis de Blacklab-CQL véase <a href="https://inl.github.io/BlackLab/corpus-query-language.html" target="_blank" rel="noopener noreferrer" class="md3-link">aquí</a>.
                </p>
                <div class="md3-prompt-container">
                  <p class="md3-prompt-title">Prompt sugerido para generar consultas CQL en CORAPAN (BlackLab)</p>
                  <p class="md3-prompt-subtitle">Copia y pega este prompt en el modelo de IA generativa y luego añade tu descripción al final:</p>
                  <div class="md3-code-block md3-full-width">
                    <pre class="highlight"><code id="cql-guide-prompt" class="language-plaintext">Actúa como generador de consultas CQL para un corpus de español hablado llamado CORAPAN, indexado en BlackLab.

El corpus está anotado con los siguientes atributos a nivel de token (dentro de corchetes `[...]` en CQL):

* `word`   → forma tal como aparece en la transcripción
* `norm`   → forma normalizada (por ejemplo, en minúsculas)
* `lemma`  → lema
* `pos`    → categoría gramatical (UD POS: `NOUN`, `VERB`, `ADJ`, `ADV`, `PRON`, `DET`, `ADP`, `SCONJ`, `CCONJ`, `PART`, `AUX`, etc.)
* `tense`  → tiempo verbal morfológico (por ejemplo: `"Pres"`, `"Past"`, `"Fut"`)
* `mood`   → modo verbal (por ejemplo: `"Ind"`, `"Subj"`, `"Imp"`)
* `person` → persona gramatical (`"1"`, `"2"`, `"3"`)
* `number` → número gramatical (`"Sing"`, `"Plur"`)
* `aspect` → aspecto verbal (si está presente)
* `PastType`   → subtipo de pasado, ya en inglés, derivado de reglas específicas del corpus. Valores posibles, si existen en el token:

  * `"simplePast"`
  * `"presentPerfect"`
  * `"pastPerfect"`
  * `"futurePerfect"`
  * `"conditionalPerfect"`
  * `"otherCompoundPast"`
  * `"otherPast"`
* `FutureType` → subtipo de futuro analítico (construcciones tipo *ir a + infinitivo*), también en inglés. Valores posibles, si existen en el token:

  * `"periphrasticFuture"` (ir a + INF con auxiliar en presente)
  * `"periphrasticFuturePast"` (ir a + INF con auxiliar en pasado, futuro en el pasado)
* `tokid`  → identificador único de cada token

Los campos `PastType` y `FutureType` **no** proceden directamente del etiquetador morfológico, sino que son clasificaciones derivadas a partir de la combinación de `tense`, `morph`, auxiliares y participios. Se consultan como cualquier otro atributo de token y se pueden combinar con `lemma`, `pos`, `tense`, etc.

Algunos ejemplos de uso:

* `[pos="VERB" & PastType="simplePast"]`
  → verbos en pretérito perfecto simple (pretérito indefinido).

* `[pos="VERB" & PastType="presentPerfect"]`
  → verbos en pretérito perfecto compuesto (*haber* + participio).

* `[pos="VERB" & PastType="pastPerfect"]`
  → verbos en pluscuamperfecto.

* `[pos="VERB" & FutureType="periphrasticFuture"]`
  → futuros perifrásticos del tipo *ir a + infinitivo* con auxiliar en presente.

* `[pos="VERB" & FutureType="periphrasticFuturePast"]`
  → futuros perifrásticos en el pasado (*iba a + infinitivo*, etc.).

* `[lemma="ir" & pos="VERB" & FutureType="periphrasticFuture"]`
  → formas de *ir* que participan en futuros perifrásticos.

Además, puedes usar metadatos de documento/segmento con BlackLab (por ejemplo mediante `within`), como:

* `country_code` → código de país/variedad (por ejemplo `ARG`, `ESP`, `ARG-CBA`, `ESP-SEV`, etc.)
* `file_id`      → identificador de archivo
* `date`         → fecha de la grabación/transcripción
* `radio`        → indica si el texto procede o no de radio (según cómo esté codificado)
* `city`         → ciudad (si está disponible)
* `sentence_id`, `utterance_id` → identificadores de oración y enunciado

Tu tarea:

1. Léeme la descripción en lenguaje natural que te daré.

2. Genera **solo** una consulta CQL válida para BlackLab, sin explicaciones ni comentarios.

3. Usa exclusivamente los atributos y metadatos listados arriba.

4. Representa las palabras y rasgos morfológicos con patrones como:

   * `[lemma="hablar"]`
   * `[pos="VERB" & tense="Pres" & person="1" & number="Sing"]`
   * `[pos="VERB" & PastType="simplePast"]` para un verbo en pretérito perfecto simple
   * `[pos="VERB" & PastType="presentPerfect"]` para un verbo en pretérito perfecto compuesto
   * `[pos="VERB" & FutureType="periphrasticFuture"]` para un futuro perifrástico del tipo *ir a + INF*
   * `[pos="ADJ"][pos="NOUN"]` para un adjetivo seguido de un sustantivo

5. Si menciono restricciones de variedad, origen o tipo de texto, exprésalas con metadatos, por ejemplo:

   * `within <country_code="ARG"> [...]`
   * `within <radio="yes"> [...]`

   (ajusta el valor según la codificación real).

6. Usa siempre comillas dobles `"..."` y la sintaxis CQL estándar de BlackLab.

7. Si la descripción es ambigua, elige la interpretación más común en lingüística hispánica, pero **no inventes** atributos que no existan en la lista ni valores de `PastType` o `FutureType` que no hayan sido definidos.

Ahora convierte la siguiente descripción en una consulta CQL precisa para CORAPAN:

«[ESCRIBE AQUÍ TU DESCRIPCIÓN EN ESPAÑOL]»

                    
                    </code>
                    </pre>
                  </div>
                </div>
              </div>
              <div class="md3-dialog__actions">
                <button type="button" class="md3-button md3-button--text md3-dialog__close" id="cql-guide-close">Cerrar</button>
                <button type="button" class="md3-button md3-button--filled" id="cql-guide-copy">
                  <span class="material-symbols-rounded">content_copy</span>
                  Copiar prompt
                </button>
              </div>
            </div>
          </div>
        </div>



      <!-- ========================================
           SUB-TABS: RESULTADOS | ESTADÍSTICAS
           Hidden by default, shown after successful search
           ======================================== -->
      <div id="search-sub-tabs" role="tablist" class="md3-stats-tabs mt-6 hidden">
        <button type="button" role="tab" id="tab-resultados" class="md3-stats-tab md3-stats-tab--active" data-view="results" aria-controls="panel-resultados" aria-selected="true">
          <span class="material-symbols-rounded" aria-hidden="true">table</span>
          <span>Resultados</span>
        </button>
        <button type="button" role="tab" id="tab-estadisticas" class="md3-stats-tab" data-view="stats" aria-controls="panel-estadisticas" aria-selected="false">
          <span class="material-symbols-rounded" aria-hidden="true">bar_chart</span>
          <span>Estadísticas</span>
        </button>
      </div>

      <!-- Results Section -->
      <div id="panel-resultados" role="tabpanel" aria-labelledby="tab-resultados" class="md3-view-content md3-view-content--active">
        <!-- Error banners will be inserted here -->
        <div id="results-section"></div>
        
        <div id="adv-summary" 
          class="md3-advanced__summary" 
          role="status" 
          aria-live="polite" 
          aria-atomic="true"
          tabindex="-1"
          hidden>
          <!-- Content loaded via JS -->
        </div>

        <!-- DataTables Container (hidden until search performed) -->
        <div id="datatable-container" class="md3-advanced__tablewrap md3-corpus-table-container hidden">
          <table id="advanced-table" class="md3-corpus-table" role="grid">
            <caption class="sr-only">
              Resultados de búsqueda avanzada. 
              Tabla con contexto izquierdo, palabra coincidente, contexto derecho, audio y metadatos.
            </caption>
            <thead>
              <tr role="row">
                <th scope="col" role="columnheader">#</th>
                <th scope="col" role="columnheader">Ctx.←</th>
                <th scope="col" role="columnheader">Resultado</th>
                <th scope="col" role="columnheader">Ctx.→</th>
                <th scope="col" role="columnheader">Audio</th>
                <th scope="col" role="columnheader">País</th>
                <th scope="col" role="columnheader">Hablante</th>
                <th scope="col" role="columnheader">Sexo</th>
                <th scope="col" role="columnheader">Modo</th>
                <th scope="col" role="columnheader">Discurso</th>
                <th scope="col" role="columnheader">Token-ID</th>
                <th scope="col" role="columnheader">Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rendered by DataTables -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Panel -->
      <div id="panel-estadisticas" role="tabpanel" aria-labelledby="tab-estadisticas" class="md3-view-content" hidden>
        <section class="md3-stats-section">
          <header class="md3-stats-header" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Summary Line (same style as results) -->
            <div id="stats-summary" class="md3-advanced__summary md3-stats-summary" role="status" aria-live="polite" aria-atomic="true">
                <span class="md3-advanced__summary-query" id="stats-summary-query"></span>: 
                <span class="md3-advanced__summary-count" id="stats-summary-count">—</span>
                <span class="md3-advanced__summary-total">resultados</span>
            </div>

            <!-- Controls Line -->
            <div class="md3-stats-controls" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div class="md3-stats-filter md3-stats-filter-group" style="display: flex; align-items: center; gap: 0.5rem;">
                  <label for="stats-country-filter" class="md3-stats-filter-label">Seleccionar:</label>
                  <select id="stats-country-filter" class="md3-stats-filter-select">
                    <option value="">Todos los países</option>
                  </select>
                </div>
                
                <button type="button" id="btn-download-stats-csv" class="md3-button md3-button--outlined md3-stats-action-end">
                    <span class="material-symbols-rounded md3-button__icon">download</span>
                    <span class="md3-button__label">Descargar CSV</span>
                </button>
            </div>
          </header>



          <div id="stats-grid" class="md3-stats-charts-grid">
            <!-- País -->
            <article class="card card-elevated" data-chart="by_country">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">País</h3>
                  <p class="md3-body-small text-on-surface-variant m-0" data-meta="by_country">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="country">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-country" aria-label="Distribución por país"></div>
              </div>
            </article>

            <!-- Tipo de hablante -->
            <article class="card card-elevated" data-chart="by_speaker_type">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Tipo de hablante</h3>
                  <p class="md3-body-small text-on-surface-variant m-0" data-meta="by_speaker_type">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="speaker">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-speaker" aria-label="Distribución por tipo de hablante"></div>
              </div>
            </article>

            <!-- Sexo -->
            <article class="card card-elevated" data-chart="by_sexo">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Sexo</h3>
                  <p class="md3-body-small text-on-surface-variant m-0" data-meta="by_sex">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="sexo">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-sexo" aria-label="Distribución por sexo"></div>
              </div>
            </article>

            <!-- Registro -->
            <article class="card card-elevated" data-chart="by_modo">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Modo de habla</h3>
                  <p class="md3-body-small text-on-surface-variant m-0" data-meta="by_modo">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="modo">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-modo" aria-label="Distribución por modo de habla"></div>
              </div>
            </article>

            <!-- Discurso -->
            <article class="card card-elevated" data-chart="by_discourse">
              <div class="md3-stats-card-header">
                <div class="md3-stats-card-title-wrapper">
                  <h3 class="md3-title-medium md3-stats-card-title">Discurso</h3>
                  <p class="md3-body-small text-on-surface-variant m-0" data-meta="by_discourse">—</p>
                </div>
                <div class="md3-segmented" data-chart-id="discourse">
                  <button class="md3-segmented-btn is-selected" data-mode="count" aria-pressed="true" aria-label="Mostrar números absolutos">
                    <span class="material-symbols-rounded" aria-hidden="true">format_list_numbered</span>
                  </button>
                  <button class="md3-segmented-btn" data-mode="percent" aria-pressed="false" aria-label="Mostrar porcentajes">
                    <span class="material-symbols-rounded" aria-hidden="true">percent</span>
                  </button>
                </div>
              </div>
              <div class="card-content">
                <div class="chart-host" id="chart-discourse" aria-label="Distribución por discurso"></div>
              </div>
            </article>
          </div>
        </section>
      </div>
    </section>

    <!-- Token Search Container (Tab: Token) -->
    <section id="tab-token" class="md3-tab-content">
      <!-- Token Search Form (MD3 Search Card) -->
      <form id="token-search-form" class="md3-search-card" role="search" aria-label="Buscar por Token-IDs">
        
        <!-- Token Input Section -->
        <div class="md3-search-card__section">
          <h2 class="md3-search-card__heading">Buscar por Token-IDs</h2>
          
          <!-- Input Row -->
          <div class="md3-search-card__query-row">
            <div class="md3-outlined-textfield md3-outlined-textfield--flex">
              <input 
                type="text" 
                id="tokid-input" 
                class="md3-outlined-textfield__input"
                placeholder=" "
                autocomplete="off">
              <label for="tokid-input" class="md3-outlined-textfield__label">Token-IDs</label>
              <div class="md3-outlined-textfield__outline">
                <div class="md3-outlined-textfield__outline-start"></div>
                <div class="md3-outlined-textfield__outline-notch"></div>
                <div class="md3-outlined-textfield__outline-end"></div>
              </div>
            </div>
            
            <button type="button" class="md3-button md3-button--filled" id="tokid-add-btn">
              <span class="material-symbols-rounded">add</span>
              <span>Añadir</span>
            </button>
          </div>
          
          <!-- Helper Text: token count moved into chip container -->
          
          <!-- Chip Container (active-filters style) -->
          <div id="tokid-chip-container" class="tokid-chip-container md3-active-filters" aria-live="polite">
            <span id="tokid-count" class="md3-active-filters__label tokid-count">0 IDs</span>
            <div id="tokid-chip-items" class="md3-active-filters__chips"></div>
          </div>
        </div>

        <!-- Actions Footer -->
        <div class="md3-search-card__footer">
          <button type="button" id="clear-tokens-btn" class="md3-button md3-button--outlined">
            <span class="material-symbols-rounded">delete</span>
            <span>Limpiar todo</span>
          </button>
          <button type="button" id="token-search-btn" class="md3-button md3-button--filled">
            <span class="material-symbols-rounded">table_view</span>
            <span>Visualizar</span>
          </button>
        </div>
      </form>
      
      <!-- Token Results Section -->
      <section id="token-results" class="md3-view-content hidden mt-8">
        <!-- Token Sub-Tabs (Resultados | Estadísticas) -->
        <div id="token-sub-tabs" role="tablist" class="md3-token-stats-tabs md3-stats-tabs mt-2 flex">
          <button type="button" role="tab" id="token-tab-resultados" class="md3-token-stats-tab md3-stats-tab md3-stats-tab--active" data-view="results" aria-controls="token-panel-resultados" aria-selected="true">
            <span class="material-symbols-rounded" aria-hidden="true">table</span>
            <span>Resultados</span>
          </button>
        </div>

        <div id="token-panel-resultados" role="tabpanel" aria-labelledby="token-tab-resultados" class="md3-view-content md3-view-content--active">

        
        <!-- DataTable Container -->
        <div class="md3-corpus-table-container">
          <table id="token-results-table" class="md3-corpus-table w-full">
            <thead>
              <tr>
                <th>#</th>
                <th>Ctx.←</th>
                <th>Resultado</th>
                <th>Ctx.→</th>
                <th>Audio</th>
                <th>País</th>
                <th>Hablante</th>
                <th>Sexo</th>
                <th>Modo</th>
                <th>Discurso</th>
                <th>Token-ID</th>
                <th>Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- DataTables (Server-Side) will populate this dynamically -->
            </tbody>
          </table>
        </div>
        </div>

        <div id="token-panel-estadisticas" role="tabpanel" aria-labelledby="token-tab-estadisticas" class="md3-view-content" hidden>
          <div class="md3-body-medium p-4">
            <div id="stats-grid" class="md3-stats-grid">
              <div id="chart-country"></div>
              <div id="chart-speaker"></div>
              <div id="chart-sexo"></div>
              <div id="chart-modo"></div>
              <div id="chart-discourse"></div>
              <div id="chart-radio"></div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </section>
</article>

<!-- Scripts in dependency order -->
<script src="{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}" defer></script>
<!-- DataTables Buttons Extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
<script src="{{ url_for('static', filename='vendor/htmx-1.9.10.min.js') }}" defer></script>
<!-- ECharts for statistics -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>

<!-- Advanced Search Entry Point -->
<script type="module" src="{{ url_for('static', filename='js/modules/search/advanced_entry.js') }}"></script>
{% endblock %}

{# Styles moved to static/css/md3/components/advanced-search.css and md3/components/editor-edit.css #}
