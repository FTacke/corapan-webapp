{% extends 'base.html' %}

{% block page_title %}Búsqueda avanzada · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- MD3 Core Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}">
<!-- MD3 Components (Base) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/textfields.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/corpus.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/alerts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/chips.css') }}">
<!-- External Libraries (CDN Base Styles BEFORE Project Overrides) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<!-- Project Overrides (AFTER CDN Styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables-theme-lock.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/advanced-search.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/search-ui.css') }}">
{% endblock %}

{% block content %}
<article class="md3-corpus-page">
  <!-- Hero Header -->
  <section class="md3-hero md3-hero--container md3-hero--with-icon" aria-label="Búsqueda avanzada en el corpus">
    <div class="md3-hero__container">
      <span class="material-symbols-rounded md3-hero__icon" aria-hidden="true">manage_search</span>
      <div class="md3-hero__content">
        <span class="md3-hero__eyebrow">Corpus</span>
        <h1 class="md3-hero__title">Búsqueda avanzada</h1>
        <p class="md3-hero__intro">
          Búsqueda con CQL (Corpus Query Language) vía BlackLab. Secuencias, POS, lemas, filtros por metadatos.
        </p>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="md3-corpus-content">
    <!-- Tab Navigation -->
    <nav class="md3-tabs" role="tablist">
      <a href="{{ url_for('corpus.corpus_home') }}" class="md3-tab" role="tab" aria-selected="false">Búsqueda simple</a>
      <button type="button" class="md3-tab md3-tab--active" role="tab" aria-selected="true" data-tab="advanced">Búsqueda avanzada</button>
      <a href="{{ url_for('corpus.corpus_home') }}#tab-token" class="md3-tab" role="tab" aria-selected="false">Token</a>
    </nav>
    
    <!-- Advanced Search Container -->
    <section class="md3-advanced">
      <!-- ========================================
           SEARCH FORM CARD (MD3 Design)
           Estructura: A-F según especificación
           ======================================== -->
      <form id="advanced-search-form" class="md3-search-card" role="search" aria-label="Búsqueda avanzada con filtros">
          
          <!-- ========================================
               A: BASIS-QUERY
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Consulta</h2>
            
            <div class="md3-search-card__query-row">
              <!-- Query Input -->
              <div class="md3-outlined-textfield md3-outlined-textfield--flex">
                <input 
                  type="text" 
                  id="q" 
                  name="q" 
                  class="md3-outlined-textfield__input" 
                  placeholder=" "
                  value="{{ request.args.get('q', '') }}"
                  required
                  aria-required="true">
                <label for="q" class="md3-outlined-textfield__label">Consulta</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>

              <!-- Search Type Dropdown -->
              <div class="md3-outlined-textfield md3-outlined-textfield--fixed">
                <select 
                  name="search_type" 
                  id="search_type" 
                  class="md3-outlined-textfield__input md3-outlined-textfield__input--select">
                  <option value="forma" {% if request.args.get('search_type') == 'forma' or not request.args.get('search_type') %}selected{% endif %}>Forma</option>
                  <option value="forma_exacta" {% if request.args.get('search_type') == 'forma_exacta' %}selected{% endif %}>Forma exacta</option>
                  <option value="lema" {% if request.args.get('search_type') == 'lema' %}selected{% endif %}>Lema</option>
                </select>
                <label for="search_type" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Tipo</label>
                <div class="md3-outlined-textfield__outline">
                  <div class="md3-outlined-textfield__outline-start"></div>
                  <div class="md3-outlined-textfield__outline-notch"></div>
                  <div class="md3-outlined-textfield__outline-end"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
               B: METADATEN-FILTER (Facettenleiste)
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Filtros de metadatos</h2>
            
            <div class="md3-filters-grid">
              <!-- País -->
              <div class="md3-filter-field" data-facet="pais">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">País</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos los países">Todos los países</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ARG" data-label="ARG">
                      <span>ARG</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="BOL" data-label="BOL">
                      <span>BOL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CHL" data-label="CHL">
                      <span>CHL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="COL" data-label="COL">
                      <span>COL</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CRI" data-label="CRI">
                      <span>CRI</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="CUB" data-label="CUB">
                      <span>CUB</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ECU" data-label="ECU">
                      <span>ECU</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="ESP" data-label="ESP">
                      <span>ESP</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="USA" data-label="USA">
                      <span>USA</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="GTM" data-label="GTM">
                      <span>GTM</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="HND" data-label="HND">
                      <span>HND</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="MEX" data-label="MEX">
                      <span>MEX</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="NIC" data-label="NIC">
                      <span>NIC</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PAN" data-label="PAN">
                      <span>PAN</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PRY" data-label="PRY">
                      <span>PRY</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="PER" data-label="PER">
                      <span>PER</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="DOM" data-label="DOM">
                      <span>DOM</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="SLV" data-label="SLV">
                      <span>SLV</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="URY" data-label="URY">
                      <span>URY</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="pais_ui" value="VEN" data-label="VEN">
                      <span>VEN</span>
                    </label>
                  </div>
                </div>
                <!-- Hidden select for backend -->
                <select name="country_code" multiple hidden>
                  <option value="ARG" {% if 'ARG' in request.args.getlist('country_code') %}selected{% endif %}>ARG</option>
                  <option value="BOL" {% if 'BOL' in request.args.getlist('country_code') %}selected{% endif %}>BOL</option>
                  <option value="CHL" {% if 'CHL' in request.args.getlist('country_code') %}selected{% endif %}>CHL</option>
                  <option value="COL" {% if 'COL' in request.args.getlist('country_code') %}selected{% endif %}>COL</option>
                  <option value="CRI" {% if 'CRI' in request.args.getlist('country_code') %}selected{% endif %}>CRI</option>
                  <option value="CUB" {% if 'CUB' in request.args.getlist('country_code') %}selected{% endif %}>CUB</option>
                  <option value="ECU" {% if 'ECU' in request.args.getlist('country_code') %}selected{% endif %}>ECU</option>
                  <option value="ESP" {% if 'ESP' in request.args.getlist('country_code') %}selected{% endif %}>ESP</option>
                  <option value="USA" {% if 'USA' in request.args.getlist('country_code') %}selected{% endif %}>USA</option>
                  <option value="GTM" {% if 'GTM' in request.args.getlist('country_code') %}selected{% endif %}>GTM</option>
                  <option value="HND" {% if 'HND' in request.args.getlist('country_code') %}selected{% endif %}>HND</option>
                  <option value="MEX" {% if 'MEX' in request.args.getlist('country_code') %}selected{% endif %}>MEX</option>
                  <option value="NIC" {% if 'NIC' in request.args.getlist('country_code') %}selected{% endif %}>NIC</option>
                  <option value="PAN" {% if 'PAN' in request.args.getlist('country_code') %}selected{% endif %}>PAN</option>
                  <option value="PRY" {% if 'PRY' in request.args.getlist('country_code') %}selected{% endif %}>PRY</option>
                  <option value="PER" {% if 'PER' in request.args.getlist('country_code') %}selected{% endif %}>PER</option>
                  <option value="DOM" {% if 'DOM' in request.args.getlist('country_code') %}selected{% endif %}>DOM</option>
                  <option value="SLV" {% if 'SLV' in request.args.getlist('country_code') %}selected{% endif %}>SLV</option>
                  <option value="URY" {% if 'URY' in request.args.getlist('country_code') %}selected{% endif %}>URY</option>
                  <option value="VEN" {% if 'VEN' in request.args.getlist('country_code') %}selected{% endif %}>VEN</option>
                </select>
              </div>

              <!-- Hablante -->
              <div class="md3-filter-field" data-facet="hablante">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Hablante</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="hablante_ui" value="pro" data-label="Profesional">
                      <span>Profesional</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="hablante_ui" value="otro" data-label="Otro">
                      <span>Otro</span>
                    </label>
                  </div>
                </div>
                <select name="speaker_type" multiple hidden>
                  <option value="pro" {% if 'pro' in request.args.getlist('speaker_type') %}selected{% endif %}>Profesional</option>
                  <option value="otro" {% if 'otro' in request.args.getlist('speaker_type') %}selected{% endif %}>Otro</option>
                </select>
              </div>

              <!-- Sexo -->
              <div class="md3-filter-field" data-facet="sexo">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Sexo</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="sexo_ui" value="m" data-label="Masculino">
                      <span>Masculino</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="sexo_ui" value="f" data-label="Femenino">
                      <span>Femenino</span>
                    </label>
                  </div>
                </div>
                <select name="sex" multiple hidden>
                  <option value="m" {% if 'm' in request.args.getlist('sex') %}selected{% endif %}>Masculino</option>
                  <option value="f" {% if 'f' in request.args.getlist('sex') %}selected{% endif %}>Femenino</option>
                </select>
              </div>

              <!-- Modo -->
              <div class="md3-filter-field" data-facet="modo">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Modo</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="pre" data-label="Anuncio">
                      <span>Anuncio</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="lectura" data-label="Lectura">
                      <span>Lectura</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="modo_ui" value="libre" data-label="Habla libre">
                      <span>Habla libre</span>
                    </label>
                  </div>
                </div>
                <select name="speech_mode" multiple hidden>
                  <option value="pre" {% if 'pre' in request.args.getlist('speech_mode') %}selected{% endif %}>Anuncio</option>
                  <option value="lectura" {% if 'lectura' in request.args.getlist('speech_mode') %}selected{% endif %}>Lectura</option>
                  <option value="libre" {% if 'libre' in request.args.getlist('speech_mode') %}selected{% endif %}>Habla libre</option>
                </select>
              </div>

              <!-- Discurso -->
              <div class="md3-filter-field" data-facet="discurso">
                <div class="md3-filter-field__trigger" tabindex="0" role="button" aria-haspopup="menu" aria-expanded="false">
                  <label class="md3-filter-field__label">Discurso</label>
                  <div class="md3-filter-field__value" data-placeholder="Todos">Todos</div>
                  <span class="material-symbols-rounded md3-filter-field__icon">expand_more</span>
                </div>
                <div class="md3-filter-field__menu" role="menu" hidden>
                  <div class="md3-filter-field__menu-content">
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="general" data-label="General">
                      <span>General</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="tiempo" data-label="Tiempo">
                      <span>Tiempo</span>
                    </label>
                    <label class="md3-filter-option">
                      <input type="checkbox" name="discurso_ui" value="tránsito" data-label="Tránsito">
                      <span>Tránsito</span>
                    </label>
                  </div>
                </div>
                <select name="discourse" multiple hidden>
                  <option value="general" {% if 'general' in request.args.getlist('discourse') %}selected{% endif %}>General</option>
                  <option value="tiempo" {% if 'tiempo' in request.args.getlist('discourse') %}selected{% endif %}>Tiempo</option>
                  <option value="tránsito" {% if 'tránsito' in request.args.getlist('discourse') %}selected{% endif %}>Tránsito</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ========================================
               ACTIVE FILTERS CHIP BAR
               ======================================== -->
          <div id="active-filters-bar" class="md3-active-filters" hidden>
            <div class="md3-active-filters__label">Filtros activos:</div>
            <div id="active-filters-chips" class="md3-active-filters__chips">
              <!-- Chips will be inserted here by JS -->
            </div>
          </div>

          <!-- ========================================
               C: OPTIONEN (Checkboxen)
               ======================================== -->
          <div class="md3-search-card__section">
            <h2 class="md3-search-card__heading">Opciones</h2>
            
            <div class="md3-options-row">
              <label class="md3-checkbox-container">
                <input type="checkbox" id="include-regional" name="include_regional" value="1" {% if request.args.get('include_regional') %}checked{% endif %}>
                <span class="md3-checkbox">
                  <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                    <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                  </svg>
                </span>
                <span class="md3-checkbox__label">Incluir emisoras regionales</span>
              </label>
              
              <label class="md3-checkbox-container">
                <input type="checkbox" id="ignore-accents" name="ignore_accents" value="1" {% if request.args.get('ignore_accents') %}checked{% endif %}>
                <span class="md3-checkbox">
                  <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                    <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                  </svg>
                </span>
                <span class="md3-checkbox__label">Ignorar acentos/mayúsculas</span>
              </label>
            </div>
          </div>

          <!-- ========================================
               D: TOGGLE FÜR ADVANCED MODE
               ======================================== -->
          <div class="md3-search-card__section md3-search-card__section--toggle">
            <label class="md3-switch-row">
              <span class="md3-switch-row__label">Modo avanzado (CQL)</span>
              <input type="checkbox" id="modo-avanzado" name="modo_avanzado" class="md3-switch-input" role="switch" aria-checked="false">
              <span class="md3-switch">
                <span class="md3-switch__track"></span>
                <span class="md3-switch__thumb"></span>
              </span>
            </label>
          </div>

          <!-- ========================================
               E: EXPERTENBEREICH (nur bei Modo avanzado)
               ======================================== -->
          <div id="expert-area" class="md3-expert-area" hidden>
            
            <!-- E1: PATTERN BUILDER -->
            <div class="md3-expert-section">
              <h3 class="md3-expert-section__title">Patrones de palabras (CQL)</h3>
              <p class="md3-expert-section__description">
                Construye patrones como 'verbo + sustantivo' paso a paso sin escribir CQL a mano.
              </p>

              <div id="pattern-builder" class="md3-pattern-builder">
                <!-- Token rows will be inserted here -->
                <div class="md3-pattern-builder__tokens" id="pattern-tokens">
                  <!-- Initial token row -->
                  <div class="md3-token-row" data-token-index="0">
                    <div class="md3-token-row__number">Token 1</div>
                    
                    <div class="md3-outlined-textfield md3-outlined-textfield--compact">
                      <select class="md3-outlined-textfield__input md3-outlined-textfield__input--select token-field-select">
                        <option value="forma">Forma</option>
                        <option value="lema">Lema</option>
                        <option value="pos">Categoría gramatical (POS)</option>
                      </select>
                      <label class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Campo</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <div class="md3-outlined-textfield md3-outlined-textfield--compact">
                      <select class="md3-outlined-textfield__input md3-outlined-textfield__input--select token-match-select">
                        <option value="exact">es exactamente</option>
                        <option value="contains">contiene</option>
                        <option value="starts">empieza por</option>
                        <option value="ends">termina en</option>
                      </select>
                      <label class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Tipo</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <div class="md3-outlined-textfield md3-outlined-textfield--flex">
                      <input 
                        type="text" 
                        class="md3-outlined-textfield__input token-value-input" 
                        placeholder=" ">
                      <label class="md3-outlined-textfield__label">Valor</label>
                      <div class="md3-outlined-textfield__outline">
                        <div class="md3-outlined-textfield__outline-start"></div>
                        <div class="md3-outlined-textfield__outline-notch"></div>
                        <div class="md3-outlined-textfield__outline-end"></div>
                      </div>
                    </div>

                    <button type="button" class="md3-icon-button token-remove-btn" title="Eliminar" disabled>
                      <span class="material-symbols-rounded">close</span>
                    </button>
                  </div>
                </div>

                <button type="button" id="add-token-btn" class="md3-button md3-button--outlined">
                  <span class="material-symbols-rounded">add</span>
                  <span>Añadir palabra siguiente</span>
                </button>

                <!-- Distance Rule -->
                <div class="md3-distance-rule">
                  <h4 class="md3-distance-rule__title">Distancia entre palabras</h4>
                  
                  <label class="md3-radio-container">
                    <input type="radio" name="distance_type" value="consecutive" checked>
                    <span class="md3-radio"></span>
                    <span class="md3-radio__label">Justo seguidas</span>
                  </label>

                  <label class="md3-radio-container">
                    <input type="radio" name="distance_type" value="gap">
                    <span class="md3-radio"></span>
                    <span class="md3-radio__label">Hasta N palabras entre medias</span>
                  </label>

                  <div id="distance-number-field" class="md3-outlined-textfield md3-outlined-textfield--compact" hidden>
                    <input 
                      type="number" 
                      id="distance-max" 
                      name="distance_max" 
                      class="md3-outlined-textfield__input" 
                      min="0" 
                      max="10" 
                      value="1"
                      placeholder=" ">
                    <label for="distance-max" class="md3-outlined-textfield__label">Número máximo de palabras entre medias</label>
                    <div class="md3-outlined-textfield__outline">
                      <div class="md3-outlined-textfield__outline-start"></div>
                      <div class="md3-outlined-textfield__outline-notch"></div>
                      <div class="md3-outlined-textfield__outline-end"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- E2: CQL PREVIEW -->
            <div class="md3-expert-section">
              <h3 class="md3-expert-section__title">Consulta CQL</h3>
              
              <div class="md3-cql-preview">
                <textarea 
                  id="cql-preview" 
                  class="md3-cql-textarea" 
                  rows="4" 
                  readonly
                  aria-label="Vista previa de la consulta CQL"></textarea>
                
                <label class="md3-checkbox-container">
                  <input type="checkbox" id="allow-manual-edit" name="allow_manual_edit">
                  <span class="md3-checkbox">
                    <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                      <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
                    </svg>
                  </span>
                  <span class="md3-checkbox__label">Permitir editar manualmente</span>
                </label>

                <div id="cql-warning" class="md3-cql-warning" hidden>
                  <span class="material-symbols-rounded">warning</span>
                  <span>Si editas la consulta CQL a mano, la interfaz de patrones puede dejar de reflejar todos los detalles.</span>
                </div>
              </div>
            </div>

            <!-- E3: PLANTILLAS RÁPIDAS -->
            <div class="md3-expert-section">
              <h3 class="md3-expert-section__title">Plantillas frecuentes</h3>
              
              <div class="md3-templates">
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="verb-noun">
                  Verbo + sustantivo
                </button>
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="adj-noun">
                  Adjetivo + sustantivo
                </button>
                <button type="button" class="md3-button md3-button--outlined template-btn" data-template="same-lemma">
                  Dos palabras con el mismo lema
                </button>
              </div>
            </div>
          </div>

          <!-- ========================================
               F: FORMULAR-FOOTER
               ======================================== -->
          <div class="md3-search-card__footer">
            <button type="button" id="reset-form-btn" class="md3-button md3-button--outlined">
              <span class="material-symbols-rounded">restart_alt</span>
              <span>Restablecer</span>
            </button>
            <button type="submit" class="md3-button md3-button--filled">
              <span class="material-symbols-rounded">search</span>
              <span>Buscar</span>
            </button>
          </div>

        </form>

      <!-- ========================================
           SUB-TABS: RESULTADOS | ESTADÍSTICAS
           ======================================== -->
      <div id="search-sub-tabs" role="tablist" class="md3-stats-tabs" style="margin-top: 1.5rem;">
        <button type="button" role="tab" id="tab-resultados" class="md3-stats-tab md3-stats-tab--active" data-view="results" aria-controls="panel-resultados" aria-selected="true">
          <span class="material-symbols-rounded" aria-hidden="true">table</span>
          <span>Resultados</span>
        </button>
        <button type="button" role="tab" id="tab-estadisticas" class="md3-stats-tab" data-view="stats" aria-controls="panel-estadisticas" aria-selected="false">
          <span class="material-symbols-rounded" aria-hidden="true">bar_chart</span>
          <span>Estadísticas</span>
        </button>
      </div>

      <!-- Results Section -->
      <div id="panel-resultados" role="tabpanel" aria-labelledby="tab-resultados" class="md3-view-content md3-view-content--active">
        <!-- Error banners will be inserted here -->
        <div id="results-section"></div>
        
        <div id="adv-summary" 
          class="md3-advanced__summary" 
          role="status" 
          aria-live="polite" 
          aria-atomic="true"
          tabindex="-1"
          hidden>
          <!-- Content loaded via JS -->
        </div>

        <!-- DataTables Container -->
        <div class="md3-advanced__tablewrap md3-corpus-table-container">
          <table id="advanced-table" class="md3-corpus-table" role="grid">
            <caption class="sr-only">
              Resultados de búsqueda avanzada. 
              Tabla con contexto izquierdo, palabra coincidente, contexto derecho, audio y metadatos.
            </caption>
            <thead>
              <tr role="row">
                <th scope="col" role="columnheader">#</th>
                <th scope="col" role="columnheader">Ctx.←</th>
                <th scope="col" role="columnheader">Resultado</th>
                <th scope="col" role="columnheader">Ctx.→</th>
                <th scope="col" role="columnheader">Audio</th>
                <th scope="col" role="columnheader">País</th>
                <th scope="col" role="columnheader">Hablante</th>
                <th scope="col" role="columnheader">Sexo</th>
                <th scope="col" role="columnheader">Modo</th>
                <th scope="col" role="columnheader">Discurso</th>
                <th scope="col" role="columnheader">Token-ID</th>
                <th scope="col" role="columnheader">Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rendered by DataTables -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Statistics Panel (placeholder for future implementation) -->
      <div id="panel-estadisticas" role="tabpanel" aria-labelledby="tab-estadisticas" class="md3-view-content" hidden>
        <div class="md3-placeholder-panel">
          <span class="material-symbols-rounded md3-placeholder-panel__icon">bar_chart</span>
          <h3 class="md3-placeholder-panel__title">Estadísticas</h3>
          <p class="md3-placeholder-panel__text">
            La funcionalidad de estadísticas se implementará en una fase posterior.
          </p>
        </div>
      </div>
    </section>
  </section>
</article>

<!-- Scripts in dependency order -->
<script src="{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='vendor/jquery.dataTables.min.js') }}" defer></script>
<!-- DataTables Buttons Extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
<script src="{{ url_for('static', filename='vendor/htmx-1.9.10.min.js') }}" defer></script>
<!-- App modules -->
<script src="{{ url_for('static', filename='js/modules/corpus/config.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/filters.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/patternBuilder.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/search/searchUI.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/advanced/initTable.js') }}" type="module"></script>
{% endblock %}
