{% extends 'base.html' %}

{% block page_title %}Búsqueda avanzada · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- MD3 Core Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}">
<!-- MD3 Components (Base) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/textfields.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/corpus.css') }}">
<!-- External Libraries (CDN Base Styles BEFORE Project Overrides) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<!-- Project Overrides (AFTER CDN Styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/select2-tagify.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/advanced-search.css') }}">
{% endblock %}

{% block content %}
<article class="md3-corpus-page">
  <!-- Hero Header -->
  <section class="md3-hero md3-hero--container md3-hero--with-icon" aria-label="Búsqueda avanzada en el corpus">
    <div class="md3-hero__container">
      <span class="material-symbols-rounded md3-hero__icon" aria-hidden="true">manage_search</span>
      <div class="md3-hero__content">
        <span class="md3-hero__eyebrow">Corpus</span>
        <h1 class="md3-hero__title">Búsqueda avanzada</h1>
        <p class="md3-hero__intro">
          Búsqueda con CQL (Corpus Query Language) vía BlackLab. Secuencias, POS, lemas, filtros por metadatos.
        </p>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="md3-corpus-content">
    <!-- Tab Navigation -->
    <nav class="md3-tabs" role="tablist">
      <a href="{{ url_for('corpus.corpus_home') }}" class="md3-tab" role="tab" aria-selected="false">Búsqueda simple</a>
      <button type="button" class="md3-tab md3-tab--active" role="tab" aria-selected="true" data-tab="advanced">Búsqueda avanzada</button>
      <a href="{{ url_for('corpus.corpus_home') }}#tab-token" class="md3-tab" role="tab" aria-selected="false">Token</a>
    </nav>
    
    <!-- Advanced Search Container -->
    <section class="md3-advanced">
      <!-- Search Form -->
      <form id="adv-form" class="md3-advanced__form" role="search" aria-label="Búsqueda avanzada con filtros">
        <!-- ROW 1: Query + Mode + Expert Toggle -->
        <div class="md3-advanced__row md3-advanced__row--query">
          <div class="md3-outlined-textfield md3-outlined-textfield--flex">
            <input 
              type="text" 
              id="q" 
              name="q" 
              class="md3-outlined-textfield__input" 
              placeholder=" "
              value="{{ request.args.get('q', '') }}"
              required
              aria-required="true">
            <label for="q" class="md3-outlined-textfield__label">Suchausdruck</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <div class="md3-outlined-textfield">
            <select 
              name="mode" 
              id="mode" 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select">
              <option value="forma_exacta" {% if request.args.get('mode') == 'forma_exacta' %}selected{% endif %}>Forma exacta</option>
              <option value="forma" {% if request.args.get('mode') == 'forma' or not request.args.get('mode') %}selected{% endif %}>Forma</option>
              <option value="lemma" {% if request.args.get('mode') == 'lemma' %}selected{% endif %}>Lemma</option>
              <option value="cql" {% if request.args.get('mode') == 'cql' %}selected{% endif %}>CQL</option>
            </select>
            <label for="mode" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Modus</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <label class="md3-advanced__expert">
            <input type="checkbox" name="expert" id="expert" {% if request.args.get('expert') %}checked{% endif %}>
            <span>Expert/CQL</span>
          </label>
        </div>

        <!-- ROW CQL: Raw CQL Field (hidden by default) -->
        <div class="md3-advanced__row md3-advanced__row--cql" id="cql-row" {% if not request.args.get('expert') %}hidden{% endif %}>
          <div class="md3-outlined-textfield md3-outlined-textfield--flex">
            <input 
              type="text" 
              id="cql_raw" 
              name="cql_raw" 
              class="md3-outlined-textfield__input" 
              placeholder=" "
              value="{{ request.args.get('cql_raw', '') }}">
            <label for="cql_raw" class="md3-outlined-textfield__label">CQL</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>
        </div>

        <!-- Filter Checkboxes (above grid, like Simple Search) -->

        <!-- ROW 2: Filters (1:1 identisch mit Simple Search) -->
        <div class="md3-corpus-filter-grid">
          <!-- País -->
          <div class="md3-outlined-textfield md3-outlined-textfield--compact">
            <select 
              id="filter-country-code" 
              name="country_code" 
              multiple 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select" 
              data-enhance="select2" 
              data-placeholder="País"
              aria-label="Filtrar por país">
              <option value=""></option>
              <option value="ARG" {% if 'ARG' in request.args.getlist('country_code') %}selected{% endif %}>Argentina</option>
              <option value="BOL" {% if 'BOL' in request.args.getlist('country_code') %}selected{% endif %}>Bolivia</option>
              <option value="CHL" {% if 'CHL' in request.args.getlist('country_code') %}selected{% endif %}>Chile</option>
              <option value="COL" {% if 'COL' in request.args.getlist('country_code') %}selected{% endif %}>Colombia</option>
              <option value="CRI" {% if 'CRI' in request.args.getlist('country_code') %}selected{% endif %}>Costa Rica</option>
              <option value="CUB" {% if 'CUB' in request.args.getlist('country_code') %}selected{% endif %}>Cuba</option>
              <option value="ECU" {% if 'ECU' in request.args.getlist('country_code') %}selected{% endif %}>Ecuador</option>
              <option value="ESP" {% if 'ESP' in request.args.getlist('country_code') %}selected{% endif %}>España</option>
              <option value="USA" {% if 'USA' in request.args.getlist('country_code') %}selected{% endif %}>Estados Unidos</option>
              <option value="GTM" {% if 'GTM' in request.args.getlist('country_code') %}selected{% endif %}>Guatemala</option>
              <option value="HND" {% if 'HND' in request.args.getlist('country_code') %}selected{% endif %}>Honduras</option>
              <option value="MEX" {% if 'MEX' in request.args.getlist('country_code') %}selected{% endif %}>México</option>
              <option value="NIC" {% if 'NIC' in request.args.getlist('country_code') %}selected{% endif %}>Nicaragua</option>
              <option value="PAN" {% if 'PAN' in request.args.getlist('country_code') %}selected{% endif %}>Panamá</option>
              <option value="PRY" {% if 'PRY' in request.args.getlist('country_code') %}selected{% endif %}>Paraguay</option>
              <option value="PER" {% if 'PER' in request.args.getlist('country_code') %}selected{% endif %}>Perú</option>
              <option value="DOM" {% if 'DOM' in request.args.getlist('country_code') %}selected{% endif %}>República Dominicana</option>
              <option value="SLV" {% if 'SLV' in request.args.getlist('country_code') %}selected{% endif %}>El Salvador</option>
              <option value="URY" {% if 'URY' in request.args.getlist('country_code') %}selected{% endif %}>Uruguay</option>
              <option value="VEN" {% if 'VEN' in request.args.getlist('country_code') %}selected{% endif %}>Venezuela</option>
            </select>
            <label for="filter-country-code" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">País</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <!-- Hablante -->
          <div class="md3-outlined-textfield md3-outlined-textfield--compact">
            <select 
              id="filter-speaker-type" 
              name="speaker_type" 
              multiple 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select" 
              data-enhance="select2" 
              data-placeholder="Hablante"
              aria-label="Filtrar por hablante">
              <option value=""></option>
              <option value="pro" {% if 'pro' in request.args.getlist('speaker_type') %}selected{% endif %}>Profesional</option>
              <option value="otro" {% if 'otro' in request.args.getlist('speaker_type') %}selected{% endif %}>Otro</option>
            </select>
            <label for="filter-speaker-type" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Hablante</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <!-- Sexo -->
          <div class="md3-outlined-textfield md3-outlined-textfield--compact">
            <select 
              id="filter-sex" 
              name="sex" 
              multiple 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select" 
              data-enhance="select2" 
              data-placeholder="Sexo"
              aria-label="Filtrar por sexo">
              <option value=""></option>
              <option value="m" {% if 'm' in request.args.getlist('sex') %}selected{% endif %}>Masculino</option>
              <option value="f" {% if 'f' in request.args.getlist('sex') %}selected{% endif %}>Femenino</option>
            </select>
            <label for="filter-sex" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Sexo</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <!-- Modo -->
          <div class="md3-outlined-textfield md3-outlined-textfield--compact">
            <select 
              id="filter-speech-mode" 
              name="speech_mode" 
              multiple 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select" 
              data-enhance="select2" 
              data-placeholder="Modo"
              aria-label="Filtrar por modo de habla">
              <option value=""></option>
              <option value="pre" {% if 'pre' in request.args.getlist('speech_mode') %}selected{% endif %}>Anuncio</option>
              <option value="lectura" {% if 'lectura' in request.args.getlist('speech_mode') %}selected{% endif %}>Lectura</option>
              <option value="libre" {% if 'libre' in request.args.getlist('speech_mode') %}selected{% endif %}>Habla libre</option>
            </select>
            <label for="filter-speech-mode" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Modo</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>

          <!-- Discurso -->
          <div class="md3-outlined-textfield md3-outlined-textfield--compact">
            <select 
              id="filter-discourse" 
              name="discourse" 
              multiple 
              class="md3-outlined-textfield__input md3-outlined-textfield__input--select" 
              data-enhance="select2" 
              data-placeholder="Discurso"
              aria-label="Filtrar por tipo de discurso">
              <option value=""></option>
              <option value="general" {% if 'general' in request.args.getlist('discourse') %}selected{% endif %}>General</option>
              <option value="tiempo" {% if 'tiempo' in request.args.getlist('discourse') %}selected{% endif %}>Tiempo</option>
              <option value="tránsito" {% if 'tránsito' in request.args.getlist('discourse') %}selected{% endif %}>Tránsito</option>
            </select>
            <label for="filter-discourse" class="md3-outlined-textfield__label md3-outlined-textfield__label--select">Discurso</label>
            <div class="md3-outlined-textfield__outline">
              <div class="md3-outlined-textfield__outline-start"></div>
              <div class="md3-outlined-textfield__outline-notch"></div>
              <div class="md3-outlined-textfield__outline-end"></div>
            </div>
          </div>
        </div>

        <!-- Filter Checkboxes (below grid, like Simple Search) -->
        <div class="md3-regional-filter-section">
          <label class="md3-checkbox-container">
            <input type="checkbox" id="include-regional" name="include_regional" value="1" {% if request.args.get('include_regional') %}checked{% endif %}>
            <span class="md3-checkbox">
              <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
              </svg>
            </span>
            <span class="md3-checkbox__label">Incluir emisoras regionales</span>
          </label>
          <label class="md3-checkbox-container">
            <input type="checkbox" id="sensitive-search" name="sensitive" value="1" {% if request.args.get('sensitive') is none or request.args.get('sensitive') == '1' %}checked{% endif %}>
            <span class="md3-checkbox">
              <svg class="md3-checkbox__checkmark" viewBox="0 0 18 18">
                <path class="md3-checkbox__checkmark-path" fill="none" stroke="white" d="M1.73,9.29 l4.75,4.75 l10.04,-10.04"></path>
              </svg>
            </span>
            <span class="md3-checkbox__label">Sensibilidad a mayúsculas y acentos</span>
          </label>
        </div>

        <!-- Actions (like Simple Search) -->
        <div class="md3-corpus-actions">
          <button type="submit" class="md3-button-filled" id="search-advanced">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Buscar</span>
          </button>
          <button type="button" class="md3-button-outlined" id="reset-filters">
            <i class="fa-solid fa-rotate-left"></i>
            <span>Restablecer</span>
          </button>
        </div>
      </form>

      <!-- Summary Box (with htmx target) -->
      <div id="adv-summary" 
        class="md3-advanced__summary" 
        role="status" 
        aria-live="polite" 
        aria-atomic="true"
        tabindex="-1"
        hidden>
        <!-- Content loaded via htmx or JS -->
      </div>

      <!-- Toolbar: Export Buttons -->
      <div class="md3-advanced__toolbar">
        <div class="md3-advanced__toolbar-spacer"></div>
        <div class="md3-advanced__exports">
          <a id="export-csv" class="md3-button-tonal" download aria-label="Descargar todos los resultados como CSV">
            <i class="fa-solid fa-download"></i>
            <span>Export CSV</span>
          </a>
          <a id="export-tsv" class="md3-button-outlined" download aria-label="Descargar todos los resultados como TSV">
            <i class="fa-solid fa-download"></i>
            <span>Export TSV</span>
          </a>
        </div>
      </div>

      <!-- DataTables Container -->
      <div class="md3-advanced__tablewrap">
        <table id="advanced-table" class="md3-corpus-table" role="grid">
          <caption class="sr-only">
            Resultados de búsqueda avanzada. 
            Tabla con contexto izquierdo, palabra coincidente, contexto derecho, audio y metadatos.
          </caption>
          <thead>
            <tr role="row">
              <th scope="col" role="columnheader">#</th>
              <th scope="col" role="columnheader">Ctx.←</th>
              <th scope="col" role="columnheader">Resultado</th>
              <th scope="col" role="columnheader">Ctx.→</th>
              <th scope="col" role="columnheader">Audio</th>
              <th scope="col" role="columnheader">País</th>
              <th scope="col" role="columnheader">Hablante</th>
              <th scope="col" role="columnheader">Sexo</th>
              <th scope="col" role="columnheader">Modo</th>
              <th scope="col" role="columnheader">Discurso</th>
              <th scope="col" role="columnheader">Token-ID</th>
              <th scope="col" role="columnheader">Archivo</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rendered by DataTables -->
          </tbody>
        </table>
      </div>
    </section>
  </section>
</article>

<!-- Scripts -->
<script src="{{ url_for('static', filename='vendor/jquery.min.js') }}"></script>
<!-- Select2 4.1.0-rc.0 (matches CSS version) -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="{{ url_for('static', filename='js/modules/corpus/config.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/corpus/filters.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/advanced/initTable.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/modules/advanced/formHandler.js') }}" type="module"></script>
{% endblock %}
