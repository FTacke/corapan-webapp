{% if error %}
<div class="md3-alert md3-alert--error" role="alert">
  <span class="material-symbols-rounded md3-alert__icon" aria-hidden="true">error</span>
  <div class="md3-alert__content">
    <strong>Error:</strong> {{ error }}
  </div>
</div>
{% elif hits %}
<!-- Results Summary -->
<div class="md3-search-summary" aria-live="polite" aria-atomic="true">
  <p class="md3-search-summary__text">
    <strong>{{ total | number_format }}</strong> resultados encontrados
    {% if server_filtered %}
    <span class="md3-chip md3-chip--assist" title="Filtrado aplicado en el servidor ({{ docs_retrieved }} de {{ number_of_docs }} documentos)">
      <span class="md3-chip__label">filtrado activo</span>
    </span>
    {% endif %}
  </p>
  {% if cql_pattern %}
  <details class="md3-search-summary__details">
    <summary>Patrón CQL generado</summary>
    <code class="md3-code-block">{{ cql_pattern }}</code>
  </details>
  {% endif %}
</div>

<!-- KWIC Results -->
<div class="md3-kwic-list">
  {% for hit in hits %}
  <div class="md3-kwic-item">
    <!-- Context -->
    <div class="md3-kwic-context">
      <span class="md3-kwic-left">{{ hit.context_left }}</span>
      <mark class="md3-kwic-hit">{{ hit.text }}</mark>
      <span class="md3-kwic-right">{{ hit.context_right }}</span>
    </div>
    
    <!-- Metadata -->
    <div class="md3-kwic-meta">
      <span class="md3-kwic-meta__item" title="Documento">
        <span class="material-symbols-rounded" aria-hidden="true">description</span>
        {{ hit.filename }}
      </span>
      {% if hit.lemma %}
      <span class="md3-kwic-meta__item" title="Lema">
        <span class="material-symbols-rounded" aria-hidden="true">label</span>
        {{ hit.lemma }}
      </span>
      {% endif %}
      {% if hit.pos %}
      <span class="md3-kwic-meta__item" title="POS">
        <span class="material-symbols-rounded" aria-hidden="true">category</span>
        {{ hit.pos }}
      </span>
      {% endif %}
      {% if hit.start_ms %}
      <span class="md3-kwic-meta__item" title="Timestamp">
        <span class="material-symbols-rounded" aria-hidden="true">schedule</span>
        {{ (hit.start_ms / 1000) | round(2) }}s
      </span>
      {% endif %}
    </div>
    
    <!-- Actions -->
    <div class="md3-kwic-actions">
      {% if hit.start_ms and hit.doc_pid %}
      <a 
        href="{{ url_for('player.player_page') }}?transcription={{ hit.doc_pid }}&audio={{ hit.doc_pid }}#t={{ hit.start_ms / 1000 }}"
        class="md3-button md3-button--text"
        target="_blank"
        rel="noopener noreferrer">
        <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">play_circle</span>
        <span class="md3-button__label">Abrir en Player</span>
      </a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if has_prev or has_next %}
<nav class="md3-pagination" aria-label="Navegación de resultados">
  {% if has_prev %}
  <a 
    href="{{ prev_url }}"
    class="md3-button md3-button--outlined"
    hx-get="{{ prev_url }}"
    hx-target="#adv-results"
    hx-indicator="#search-progress"
    hx-push-url="true">
    <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">chevron_left</span>
    <span class="md3-button__label">Anterior</span>
  </a>
  {% else %}
  <span class="md3-button md3-button--outlined md3-button--disabled" aria-disabled="true">
    <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">chevron_left</span>
    <span class="md3-button__label">Anterior</span>
  </span>
  {% endif %}

  <span class="md3-pagination__info">
    Resultados {{ hitstart + 1 }} – {{ [hitstart + maxhits, total] | min }} de {{ total | number_format }}
  </span>

  {% if has_next %}
  <a 
    href="{{ next_url }}"
    class="md3-button md3-button--outlined"
    hx-get="{{ next_url }}"
    hx-target="#adv-results"
    hx-indicator="#search-progress"
    hx-push-url="true">
    <span class="md3-button__label">Siguiente</span>
    <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">chevron_right</span>
  </a>
  {% else %}
  <span class="md3-button md3-button--outlined md3-button--disabled" aria-disabled="true">
    <span class="md3-button__label">Siguiente</span>
    <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">chevron_right</span>
  </span>
  {% endif %}
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="md3-empty-state">
  <span class="material-symbols-rounded md3-empty-state__icon" aria-hidden="true">search_off</span>
  <p class="md3-empty-state__text">No se encontraron resultados.</p>
  <p class="md3-empty-state__hint">Intenta con términos diferentes o ajusta los filtros.</p>
</div>
{% endif %}
