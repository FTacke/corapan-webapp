<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block page_title %}CO.RA.PAN{% endblock %}</title>
    <!-- Theme color for consistent appearance during Turbo navigation (prevents blue flash) -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#121212">
    <!-- Critical inline CSS: Prevent flash during page load and Turbo navigation -->
    <style>
      /* Base colors - prevent flash during Turbo navigation */
      html, body {
        background: #fff;
        color-scheme: light dark;
        transition: none !important; /* Prevent any transition flash */
        /* Disable tap highlight on touch devices (prevents blue flash on mobile) */
        -webkit-tap-highlight-color: transparent;
        tap-highlight-color: transparent;
      }
      @media (prefers-color-scheme: dark) {
        html, body {
          background: #121212;
        }
      }
      
      /* Turbo Progress Bar - correct styling to prevent fullscreen blue */
      turbo-progress-bar {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: auto !important;
        bottom: auto !important;
        height: 2px !important;
        width: 0 !important;
        max-width: 100vw !important;
        background: var(--md-sys-color-primary, #1976d2) !important;
        z-index: 9999 !important;
        display: block !important;
        /* Prevent any fullscreen or overlay behavior */
        inset: unset !important;
        /* TEMPORARY DEBUG: Uncomment next line to hide progress bar completely to test if it causes flash */
        /* visibility: hidden !important; */
      }
      
      /* Hide selects during Turbo hydration to prevent options flash */
      .corpus-hydrating .md3-corpus-filter-grid select[data-enhance]:not([data-enhanced]),
      .md3-corpus-filter-grid select[data-enhance][data-enhance-pending] {
        visibility: hidden;
      }
      .no-js .md3-corpus-filter-grid select[data-enhance] {
        visibility: visible; /* Fallback without JS */
      }
      
      /* Prevent focus effects during hydration */
      body[data-hydrating] :focus,
      body[data-hydrating] :focus-visible {
        outline: none !important;
        box-shadow: none !important;
        background: transparent !important;
      }
      
      /* Font display swap for external fonts to prevent layout shift */
      @font-face {
        font-display: swap;
      }
    </style>
    <!-- Remove no-js class immediately if JavaScript is enabled -->
    <script>document.documentElement.classList.remove('no-js');</script>
    <!-- Preload critical resources to prevent FOUC -->
    <link rel="preload" href="{{ url_for('static', filename='css/layout.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='css/md3/tokens.css') }}" as="style">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}" data-turbo-track="reload">
    <!-- Font Awesome 6.7.1 (fixes glyph bbox warnings) - async loaded -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" media="print" onload="this.media='all'; this.onload=null;">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"></noscript>
    <!-- Bootstrap Icons - async loaded -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" media="print" onload="this.media='all'; this.onload=null;">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"></noscript>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
    <!-- MD3 Design System Foundation -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}" data-turbo-track="reload">
    <!-- MD3 Components for Navigation/Footer -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/navbar.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/navigation-drawer.css') }}?v=2" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/top-app-bar.css') }}?v=2" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/material-symbols-fallback.css') }}?v=2" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/status-banner.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/footer.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/page-navigation.css') }}" data-turbo-track="reload">
    <!-- MD3 Common Components (für Turbo Frame-Navigation) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/text-pages.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/cards.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/stats.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/como-citar.css') }}" data-turbo-track="reload">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/player-mobile.css') }}" data-turbo-track="reload">
    <script>
      window.__CORAPAN__ = {
        allowPublicTempAudio: {{ 'true' if allow_public_temp_audio else 'false' }},
      };
    </script>
    <!-- Turbo for persistent navigation (SSR + Frame-based navigation) -->
    <script type="module" src="{{ url_for('static', filename='js/turbo.esm.js') }}"></script>
    {% block extra_head %}{% endblock %}
  </head>
  <body class="app-shell bg-page text-ink">
    {# MD3 Navigation System - Persistent (nicht neu laden bei Page-Wechsel) #}
    {% include 'partials/status_banner.html' %}
    
    <header id="top-app-bar" data-turbo-permanent>
      {% include 'partials/_top_app_bar.html' %}
    </header>
    
    <aside id="navigation-drawer" data-turbo-permanent>
      {% include 'partials/_navigation_drawer.html' %}
    </aside>
    
    {# Main Content - Turbo Drive lädt diese Sektion neu #}
    <main id="main-content" class="site-main">
      <div class="md3-content-wrapper">
        {% block content %}{% endblock %}
      </div>
    </main>
    
    <footer id="site-footer" class="md3-footer" data-turbo-permanent>
      {% include 'partials/footer.html' %}
    </footer>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script type="module" src="{{ url_for('static', filename='js/modules/navigation/index.js') }}?v=3" defer></script>
    {% block extra_scripts %}
    {% endblock %}
  </body>
</html>
