{# MD3 Top App Bar - Adaptive Opazität via CSS Media Queries #}
{# Expanded (≥840px): Transparent, kein Burger, kein Titel (permanenter Drawer sichtbar) #}
{# Compact/Medium (<840px): Opak mit Elevation, Burger links, kein Titel (modaler Drawer) #}
{# Rechts: Login-Button ODER Avatar mit Logout-Menü #}

{% set user_name = g.user %}
{% set user_role = g.role %}
{% set is_authenticated = user_name is not none %}
{% set role_value = user_role.value if user_role else '' %}

<header class="md3-top-app-bar" 
        role="banner"
        data-role="top-app-bar"
        data-element="top-app-bar"
        data-role="top-app-bar"
        data-size="small"
        data-auth="{{ 'true' if is_authenticated else 'false' }}">
  <div class="md3-top-app-bar__row">
    {# Left: Burger Icon (nur Compact/Medium, versteckt auf Expanded via CSS) #}
    <button type="button" 
            class="md3-icon-button md3-top-app-bar__navigation-icon" 
            aria-label="Menú"
            aria-controls="navigation-drawer-modal"
            aria-expanded="false"
            data-action="open-drawer">
      <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">menu</span>
    </button>

    {# Center: Adaptive Title (Site → Page beim Scrollen) #}
    <div class="md3-top-app-bar__title" aria-live="polite" aria-atomic="true">
      <span class="md3-top-app-bar__title-site" id="siteTitle" data-site-title>CO.RA.PAN</span>
      <span class="md3-top-app-bar__title-page" id="pageTitle" data-page-title-el></span>
    </div>

    {# Right: Login/Account Actions #}
    <div class="md3-top-app-bar__actions">
      {# Theme Toggle (Light/Dark) - erscheint immer #}
      <button id="themeToggle"
              type="button"
              class="md3-icon-button md3-theme-toggle" 
              aria-label="Darstellung umschalten"
              aria-pressed="false"
              title="Darstellung: Hell">
        <span id="themeIcon" class="material-symbols-rounded" aria-hidden="true">light_mode</span>
      </button>

      {% if is_authenticated %}
        {# Authenticated: Account button (MD3) - Text button with badge #}
        <div class="md3-user-menu" data-user-menu-root>
          <button
              class="md3-button md3-button--text md3-account-button"
              type="button"
              aria-haspopup="menu"
              aria-expanded="false"
              aria-label="Angemeldet als {{ user_name }}, Rolle: {{ role_value }}"
              aria-controls="user-menu-dropdown"
              data-account-menu-trigger
              data-user-menu-toggle>
            
            <span class="material-symbols-rounded md3-button__icon" aria-hidden="true">
              account_circle
            </span>

            <span class="md3-account-button__user">
              {{ user_name }}
            </span>

            {# Role Badge #}
            {% if role_value == 'admin' %}
                <span class="md3-badge md3-badge--role-admin">
                  <span class="material-symbols-rounded md3-badge__icon" aria-hidden="true">admin_panel_settings</span>
                  <span class="md3-badge__label">Admin</span>
                </span>
            {% elif role_value == 'editor' %}
                <span class="md3-badge md3-badge--role-editor">
                  <span class="material-symbols-rounded md3-badge__icon" aria-hidden="true">person_edit</span>
                  <span class="md3-badge__label">Editor</span>
                </span>
            {% else %}
                <span class="md3-badge md3-badge--role-user">
                  <span class="material-symbols-rounded md3-badge__icon" aria-hidden="true">person_check</span>
                  <span class="md3-badge__label">Usuario</span>
                </span>
            {% endif %}
          </button>

          {# Logout Menu (NUR "Abmelden", keine Profile-Details) #}
          <div class="md3-user-menu__dropdown" 
               id="user-menu-dropdown"
               role="menu"
               aria-label="Benutzermenü"
               data-user-menu
               hidden>
            {# Common profile actions for authenticated users #}
            <a href="{{ url_for('auth.account_profile_page') }}" class="md3-user-menu__item" role="menuitem">
              <span class="material-symbols-rounded md3-user-menu__icon">account_circle</span>
              <span class="md3-user-menu__label">Perfil</span>
            </a>
            {% if role_value == 'admin' %}
              <div class="md3-user-menu__divider" role="separator"></div>
              {# Admin Dashboard Link #}
              <a href="{{ url_for('admin.dashboard') }}" class="md3-user-menu__item" role="menuitem">
                <span class="material-symbols-rounded md3-user-menu__icon">dashboard</span>
                <span class="md3-user-menu__label">Dashboard</span>
              </a>
              <a href="{{ url_for('auth.admin_users_page') }}" class="md3-user-menu__item" role="menuitem">
                <span class="material-symbols-rounded md3-user-menu__icon">group</span>
                <span class="md3-user-menu__label">Usuarios</span>
              </a>
              <div class="md3-user-menu__divider" role="separator"></div>
            {% endif %}
            {# Logout via GET (no CSRF, idempotent) #}
            <a href="{{ url_for('auth.logout_any') }}"
              data-logout="fetch"
              data-logout-method="POST"
              data-logout-url="{{ url_for('auth.logout_any') }}"
              class="md3-user-menu__item md3-user-menu__item--logout"
              role="menuitem">
              <span class="material-symbols-rounded md3-user-menu__icon">logout</span>
              <span class="md3-user-menu__label">Cerrar sesión</span>
            </a>
          </div>
        </div>
      {% else %}
          {# Unauthenticated: Login Button — navigate to canonical login page (/login) #}
          <a href="{{ url_for('public.login', next=request.full_path|default(request.path)) }}"
            class="md3-icon-button" 
            aria-label="Iniciar sesión"
            title="Iniciar sesión">
          <span class="material-symbols-rounded">account_circle</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>

{# Login Sheet removed - now defined globally in status_banner.html #}
{# This ensures a single, consistent login experience across the app #}

