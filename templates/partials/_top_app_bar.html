{# MD3 Top App Bar - Adaptive Opazität via CSS Media Queries #}
{# Expanded (≥840px): Transparent, kein Burger, kein Titel (permanenter Drawer sichtbar) #}
{# Compact/Medium (<840px): Opak mit Elevation, Burger links, kein Titel (modaler Drawer) #}
{# Rechts: Login-Button ODER Avatar mit Logout-Menü #}

{% set user_name = g.get('user') %}
{% set user_role = g.get('role') %}
{% set is_authenticated = user_name is not none %}
{% set role_value = user_role.value if user_role else '' %}

<header class="md3-top-app-bar" 
        role="banner" 
        data-element="top-app-bar"
        data-size="small"
        data-auth="{{ 'true' if is_authenticated else 'false' }}">
  <div class="md3-top-app-bar__row">
    {# Left: Burger Icon (nur Compact/Medium, versteckt auf Expanded via CSS) #}
    <button type="button" 
            class="md3-icon-button md3-top-app-bar__navigation-icon" 
            aria-label="Menú"
            aria-controls="navigation-drawer-modal"
            aria-expanded="false"
            data-action="open-drawer">
      <span class="material-symbols-rounded">menu</span>
    </button>

    {# Center: Adaptive Title (Site → Page beim Scrollen) #}
    <div class="md3-top-app-bar__title" aria-live="polite" aria-atomic="true">
      <span class="md3-top-app-bar__title-site" id="siteTitle">CO.RA.PAN</span>
      <span class="md3-top-app-bar__title-page" id="pageTitle"></span>
    </div>

    {# Right: Login/Account Actions #}
    <div class="md3-top-app-bar__actions">
      {# Theme Toggle (Light/Dark) - erscheint immer #}
      <button id="themeToggle"
              type="button"
              class="md3-icon-button md3-theme-toggle" 
              aria-label="Darstellung umschalten"
              aria-pressed="false"
              title="Darstellung: Hell">
        <span id="themeIcon" class="material-symbols-rounded" aria-hidden="true">light_mode</span>
      </button>

      {% if is_authenticated %}
        {# Authenticated: Avatar mit Logout-Menü (nur "Abmelden") #}
        <div class="md3-user-menu" data-user-menu-root>
          <button type="button" 
                  class="md3-icon-button md3-user-menu__toggle" 
                  aria-label="Konto: {{ user_name }}"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="user-menu-dropdown"
                  data-user-menu-toggle>
            <span class="md3-user-menu__avatar">
              {{ user_name[:1]|upper if user_name else 'U' }}
            </span>
          </button>

          {# Logout Menu (NUR "Abmelden", keine Profile-Details) #}
          <div class="md3-user-menu__dropdown" 
               id="user-menu-dropdown"
               role="menu"
               aria-label="Benutzermenü"
               data-user-menu
               hidden>
            {% if role_value == 'admin' %}
              {# Admin Dashboard Link #}
              <a href="{{ url_for('admin.dashboard') }}" 
                 class="md3-user-menu__item" 
                 role="menuitem">
                <span class="material-symbols-rounded md3-user-menu__icon">dashboard</span>
                <span class="md3-user-menu__label">Dashboard</span>
              </a>
              <div class="md3-user-menu__divider" role="separator"></div>
            {% endif %}
            {# Logout via GET (no CSRF, idempotent) #}
            <a href="{{ url_for('auth.logout_any') }}" 
               class="md3-user-menu__item" 
               role="menuitem">
              <span class="material-symbols-rounded md3-user-menu__icon">logout</span>
              <span class="md3-user-menu__label">Cerrar sesión</span>
            </a>
          </div>
        </div>
      {% else %}
        {# Unauthenticated: Login Button (Icon: account_circle) - HTMX Sheet #}
        <a hx-get="{{ url_for('auth.login_sheet', next=request.full_path|default(request.path)) }}"
           hx-target="body"
           hx-swap="beforeend"
           class="md3-icon-button" 
           aria-label="Iniciar sesión"
           title="Iniciar sesión">
          <span class="material-symbols-rounded">account_circle</span>
        </a>
      {% endif %}
    </div>
  </div>
</header>

{# Login Sheet removed - now defined globally in status_banner.html #}
{# This ensures a single, consistent login experience across the app #}

