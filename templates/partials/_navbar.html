{% set user_name = g.get('user') %}
{% set user_role = g.get('role') %}
{% set is_authenticated = user_name is not none %}
{% set role_value = user_role.value if user_role else '' %}
{% set role_label = (role_value or 'user').upper() %}
{% set role_icons = {
  'admin': 'fa-solid fa-user-shield',
  'editor': 'fa-solid fa-user-pen',
  'user': 'fa-solid fa-user'
} %}
{% set active_endpoint = request.endpoint %}
{% set nav_links = [
  {
    'label': 'Inicio',
    'href': url_for('public.landing_page'),
    'match': ['public.landing_page']
  },
  {
    'label': 'Proyecto',
    'href': url_for('public.proyecto_overview'),
    'match': ['public.proyecto_overview', 'public.proyecto_page'],
    'children': [
      { 'label': 'El proyecto', 'href': url_for('public.proyecto_overview') },
      { 'label': 'Diseño', 'href': url_for('public.proyecto_diseno') },
      { 'label': 'Estadísticas', 'href': url_for('public.proyecto_estadisticas') },
      { 'label': 'Quiénes somos', 'href': url_for('public.proyecto_quienes_somos') },
      { 'label': 'Cómo citar', 'href': url_for('public.proyecto_como_citar') }
    ]
  },
  {
    'label': 'Corpus',
    'href': url_for('corpus.corpus_home'),
    'match': ['corpus.corpus_home', 'corpus.search']
  },
  {
    'label': 'Atlas',
    'href': url_for('public.atlas_page'),
    'match': ['public.atlas_page']
  }
] %}

{# Editor-Link für Admin und Editor #}
{% if is_authenticated and role_value in ['admin', 'editor'] %}
  {% set nav_links = nav_links + [{
    'label': 'Editor',
    'href': url_for('editor.overview'),
    'match': ['editor.overview', 'editor.edit_file'],
    'role_required': ['admin', 'editor']
  }] %}
{% endif %}

<header class="site-header" data-auth="{{ 'true' if is_authenticated else 'false' }}" data-role="{{ role_value }}">
  <nav class="md3-nav" aria-label="Navegación principal">
    <div class="md3-nav__inner">
      <!-- Brand & Desktop Links -->
      <div class="md3-nav__brand">
        <!-- Mobile Menu Toggle -->
        <button type="button" class="md3-icon-button md3-nav__mobile-toggle" data-mobile-toggle aria-controls="mobile-menu" aria-expanded="false" aria-label="Menú abrir">
          <i class="fa-solid fa-bars"></i>
        </button>
        
        <!-- Logo -->
        <a href="{{ url_for('public.landing_page') }}" class="md3-nav__logo-link">
          <img src="{{ url_for('static', filename='img/logo_transparent.png') }}" alt="CO.RA.PAN" class="md3-nav__logo" loading="lazy">
        </a>
        
        <!-- Desktop Navigation Links -->
        <div class="md3-nav__links" role="list">
          {% for item in nav_links %}
            {# determine active for parent: endpoint match OR any child href matches request.path #}
            {% set is_active = active_endpoint in item.match %}
            {% if item.children %}
              {% for c in item.children %}
                {% if request.path == c.href or request.path.startswith(c.href + '/') %}
                  {% set is_active = true %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {% if item.children %}
              <div class="md3-nav__link-with-menu">
                <!-- Make the entire label a single trigger button per MD3: it opens the menu instead of navigating immediately -->
                <button type="button" class="md3-label-large md3-nav__link md3-nav__trigger" aria-haspopup="menu" aria-expanded="false" aria-controls="nav-submenu-{{ loop.index }}">{{ item.label }} <span class="md3-nav__trigger-icon">▾</span></button>

                <div id="nav-submenu-{{ loop.index }}" class="md3-nav__submenu" role="menu" hidden>
                  <ul>
                    {% for child in item.children %}
                        {% set child_is_active = (request.path == child.href) or (request.path.startswith(child.href + '/')) or (active_endpoint in (child.get('match', []) if child is mapping else [])) %}
                        <li role="menuitem"><a href="{{ child.href }}" class="md3-nav__submenu-link {{ 'md3-nav__link--active' if child_is_active else '' }}" aria-current="{{ 'page' if child_is_active else 'false' }}">{{ child.label }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            {% else %}
              <a href="{{ item.href }}" class="md3-label-large md3-nav__link {{ 'md3-nav__link--active' if is_active else '' }}" aria-current="{{ 'page' if is_active else 'false' }}">{{ item.label }}</a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- Actions -->
      <div class="md3-nav__actions">
        {% if is_authenticated %}
          <div class="md3-user-menu" data-user-menu-root>
            <button type="button" class="md3-icon-button md3-user-menu__toggle" data-user-menu-toggle aria-haspopup="true" aria-expanded="false">
              <span class="sr-only">Abrir menú de usuario</span>
              <span class="md3-user-avatar" aria-hidden="true">
                {{ user_name[:1]|upper if user_name else 'U' }}
              </span>
            </button>
            
            <div class="md3-user-menu__dropdown md3-elevation-3" data-user-menu hidden role="menu">
              <div class="md3-user-menu__profile">
                <span class="md3-user-avatar md3-user-avatar--lg" aria-hidden="true">
                  {{ user_name[:1]|upper if user_name else 'U' }}
                </span>
                <div class="md3-user-menu__details">
                  <span class="md3-label-large md3-user-menu__name">{{ user_name }}</span>
                  <span class="md3-label-small md3-user-menu__role">{{ role_label }}</span>
                </div>
              </div>
              
              <ul class="md3-user-menu__list" role="none">
                {% if role_value == 'admin' %}
                  <li role="none">
                    <a href="{{ url_for('admin.dashboard') }}" class="md3-body-medium md3-user-menu__link" role="menuitem">
                      <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
                      <span>Panel administrativo</span>
                    </a>
                  </li>
                {% endif %}
                <li role="none">
                  <form method="post" 
                        action="{{ url_for('auth.logout') }}" 
                        data-element="logout-form-menu" 
                        role="none" 
                        class="md3-user-menu__form"
                        data-turbo="false">
                    <input type="hidden" name="csrf_token" value="" data-element="csrf-token">
                    <button type="submit" class="md3-body-medium md3-user-menu__link md3-user-menu__link--danger" role="menuitem">
                      <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                      <span>Cerrar sesión</span>
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        {% else %}
          <button type="button" class="md3-icon-button" data-action="open-login" aria-label="Iniciar sesión">
            <i class="fa-regular fa-circle-user"></i>
          </button>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="md3-mobile-menu" data-mobile-menu hidden>
    <div class="md3-mobile-menu__backdrop" data-mobile-backdrop></div>
    <div class="md3-mobile-menu__panel md3-elevation-4" role="dialog" aria-modal="true" aria-label="Menú móvil">
      <div class="md3-mobile-menu__header">
        <!-- Logo removed for cleaner mobile menu per user request -->
        <div></div>
        <button type="button" class="md3-icon-button" data-mobile-close aria-label="Menú cerrar">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      
      <nav class="md3-mobile-menu__links" aria-label="Enlaces principales">
        {% for item in nav_links %}
          {% set is_active = active_endpoint in item.match %}
          {% if item.children %}
            {# Collapsible menu item with children #}
            <div class="md3-mobile-collapsible">
              <button type="button" class="md3-label-large md3-mobile-link md3-mobile-collapsible__trigger" aria-expanded="false" aria-controls="mobile-collapse-{{ loop.index }}">
                <span class="md3-mobile-link__text">{{ item.label }}</span>
                <i class="md3-mobile-link__chevron fa-solid fa-chevron-down" aria-hidden="true"></i>
              </button>
              
              <div id="mobile-collapse-{{ loop.index }}" class="md3-mobile-collapsible__content" hidden>
                <nav class="md3-mobile-collapsible__items" aria-label="Subenlaces de {{ item.label }}">
                  {% for child in item.children %}
                    {% set child_is_active = (request.path == child.href) or (request.path.startswith(child.href + '/')) or (active_endpoint in (child.get('match', []) if child is mapping else [])) %}
                    <a href="{{ child.href }}" class="md3-mobile-link md3-mobile-link--child {{ 'md3-mobile-link--active' if child_is_active else '' }}" aria-current="{{ 'page' if child_is_active else 'false' }}">{{ child.label }}</a>
                  {% endfor %}
                </nav>
              </div>
            </div>
          {% else %}
            {# Simple link without children #}
            <a href="{{ item.href }}" class="md3-label-large md3-mobile-link {{ 'md3-mobile-link--active' if is_active else '' }}" aria-current="{{ 'page' if is_active else 'false' }}">{{ item.label }}</a>
          {% endif %}
        {% endfor %}
      </nav>
      
      <div class="md3-mobile-menu__footer">
        {% if is_authenticated %}
          <div class="md3-mobile-account">
            <i class="{{ role_icons.get(role_value, role_icons['user']) }}" aria-hidden="true"></i>
            <span class="md3-label-large">{{ role_label }}</span>
          </div>
          {% if role_value == 'admin' %}
            <a href="{{ url_for('admin.dashboard') }}" class="md3-label-large md3-mobile-link" aria-label="Panel administrativo">Panel admin</a>
          {% endif %}
          <form method="post" 
                action="{{ url_for('auth.logout') }}" 
                data-element="logout-form-mobile"
                data-turbo="false">
            <input type="hidden" name="csrf_token" value="" data-element="csrf-token">
            <button type="submit" class="md3-label-large md3-mobile-link md3-mobile-link--button">Cerrar sesión</button>
          </form>
        {% else %}
          <button type="button" class="md3-label-large md3-mobile-link md3-mobile-link--button" data-action="open-login">Iniciar sesión</button>
        {% endif %}
      </div>
    </div>
  </div>
</header>

<!-- Login Sheet removed - now defined globally in status_banner.html -->
<!-- This ensures a single, consistent login experience across the app -->
