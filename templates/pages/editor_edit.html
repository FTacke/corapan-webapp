{% extends "base.html" %}

{% block page_title %}Editor: {{ filename }} - CO.RA.PAN{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/transcription-shared.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/editor-edit.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/audio-player.css') }}">
{% endblock %}

{% block content %}
<div class="md3-player-page">
  <!-- Header with File Info -->
  <div class="md3-player-header">
    <a href="{{ url_for('editor.overview') }}" class="back-link">
      <i class="bi bi-chevron-left"></i>
    </a>
    <h1 class="document-title">{{ country }}/{{ filename }}</h1>
  </div>

  <!-- Main Container: Transcript + Sidebar -->
  <div class="md3-player-container">
    <!-- Left Column: Transcript -->
    <div class="md3-player-transcript">
      <div id="transcriptionContainer"></div>
    </div>

    <!-- Right Column: Sidebar -->
    <aside class="player-sidebar">
      <section class="md3-editor-pane">
        <div class="md3-editor-cards">
          <!-- Status Card (NEUE Card ganz oben) -->
          <div class="md3-editor-card">
            <div class="md3-editor-card-header">
              <i class="bi bi-info-circle"></i>
              <h2 class="md3-editor-card-title">Status</h2>
            </div>
            <span id="save-indicator" class="md3-editor-status-badge md3-editor-status-saved">
              <i class="bi bi-check-circle"></i> Gespeichert
            </span>
          </div>

          <!-- Bearbeitung Card -->
          <div class="md3-editor-card">
            <div class="md3-editor-card-header">
              <i class="bi bi-pencil"></i>
              <h2 class="md3-editor-card-title">Bearbeitung</h2>
            </div>

            <div class="md3-editor-metrics">
              <div class="md3-editor-metrics-info">
                <span class="md3-editor-label">Geänderte Wörter</span>
                <span id="modified-count" class="md3-editor-value">0</span>
              </div>
              <div class="md3-editor-actions-inline">
                <button id="undo-btn" class="md3-editor-btn-icon" disabled title="Rückgängig (CTRL+Z)">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button id="redo-btn" class="md3-editor-btn-icon" disabled title="Wiederholen (CTRL+Y)">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>

            <div id="word-edit-info" class="md3-editor-edit-info hidden">
              <p class="md3-editor-edit-label">Aktives Wort:</p>
              <p id="current-word" class="md3-editor-current-word"></p>
              <div class="md3-editor-edit-actions">
                <button id="cancel-edit-btn" class="md3-editor-btn md3-editor-btn-sm md3-editor-btn-tonal" title="ESC">
                  <i class="bi bi-x"></i> Abbrechen
                </button>
              </div>
            </div>

            <div id="speaker-selection" class="md3-editor-speaker-selection hidden">
              <p class="md3-editor-edit-label">Speaker des Segments:</p>
              <select id="speaker-select" class="md3-editor-speaker-select">
                <option value="">– Wählen Sie einen Speaker –</option>
              </select>
              <div class="md3-editor-speaker-actions">
                <button id="confirm-speaker-btn" class="md3-editor-btn md3-editor-btn-sm md3-editor-btn-primary">
                  <i class="bi bi-check"></i> Speichern
                </button>
                <button id="cancel-speaker-btn" class="md3-editor-btn md3-editor-btn-sm md3-editor-btn-tonal">
                  <i class="bi bi-x"></i> Abbrechen
                </button>
              </div>
            </div>

            <div class="md3-editor-cta-row">
              <button id="save-btn" class="md3-editor-btn md3-editor-btn-primary md3-editor-btn-block">
                <i class="bi bi-save"></i> speichern
              </button>
              <button id="discard-btn" class="md3-editor-btn md3-editor-btn-error md3-editor-btn-block">
                <i class="bi bi-trash"></i> verwerfen
              </button>
            </div>
          </div>

          <!-- Bookmarks Card -->
          <div class="md3-editor-card">
            <div class="md3-editor-card-header">
              <i class="bi bi-bookmark-check"></i>
              <h2 class="md3-editor-card-title">Bookmarks</h2>
            </div>
            <button id="bookmark-btn" class="md3-editor-bookmark-btn" title="Bookmark hinzufügen">
              <i class="bi bi-bookmark-plus"></i>
              Bookmark
            </button>
            <div id="bookmark-list" class="md3-editor-bookmark-list">
              <!-- Bookmarks will be rendered here -->
            </div>
          </div>

          <!-- History Card -->
          <div class="md3-editor-card">
            <div class="md3-editor-card-header">
              <i class="bi bi-clock-history"></i>
              <h2 class="md3-editor-card-title">Änderungshistorie</h2>
            </div>
            <div id="history-panel" class="md3-editor-history-panel">
              <!-- History timeline will be rendered here -->
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>

  <!-- Audio Player Component -->
  {% from 'partials/audio-player.html' import render_audio_player %}
  {{ render_audio_player() }}
</div>

<!-- Configuration for JavaScript -->
<script type="application/json" id="editor-config">
{
  "audioFile": "{{ audio_file }}",
  "transcriptFile": "{{ transcript_file }}",
  "country": "{{ country }}",
  "filename": "{{ filename }}",
  "apiBaseUrl": "/editor",
  "apiEndpoints": {
    "saveEdits": "{{ url_for('editor.save_edits') }}",
    "addBookmark": "{{ url_for('editor.add_bookmark') }}",
    "removeBookmark": "{{ url_for('editor.remove_bookmark') }}",
    "getBookmarks": "{{ url_for('editor.get_bookmarks', country=country, filename=filename) }}",
    "getHistory": "{{ url_for('editor.get_history', country=country, filename=filename) }}",
    "undo": "{{ url_for('editor.undo_change') }}"
  }
}
</script>

<script type="module">
  import { EditorPlayer } from '{{ url_for("static", filename="js/editor/editor-player.js") }}';
  import { DialogUtils } from '{{ url_for("static", filename="js/editor/dialog-utils.js") }}';
  
  // Make dialog utilities globally available
  window.DialogUtils = DialogUtils;
  
  // Initialize editor when DOM is ready
  document.addEventListener('DOMContentLoaded', async () => {
    const config = JSON.parse(document.getElementById('editor-config').textContent);
    const editor = new EditorPlayer(config);
    await editor.init();
  });
</script>
{% endblock %}
