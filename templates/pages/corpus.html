{% extends 'base.html' %}

{% block page_title %}Corpus · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- MD3 Core Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/tokens.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/typography.css') }}">
<!-- MD3 Components -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/hero.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/textfields.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/corpus.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/token-chips.css') }}">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/datatables-theme-lock.css') }}">
{% endblock %}

{% block content %}
<article class="md3-corpus-page">
  <!-- Hero Header (Container Hero - Tonal with Icon) -->
  <section class="md3-hero md3-hero--container md3-hero--with-icon" role="main" aria-label="Búsqueda en el corpus">
    <div class="md3-hero__container">
      <span class="material-symbols-rounded md3-hero__icon" aria-hidden="true">search_insights</span>
      <div class="md3-hero__content">
        <span class="md3-hero__eyebrow">Corpus</span>
        <h1 class="md3-hero__title">Buscar en el corpus</h1>
        <p class="md3-hero__intro">
          Busca palabras o secuencias de letras o palabras, filtra por país, hablante y registro.
        </p>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="md3-corpus-content">
    <!-- Tab Navigation -->
    <nav class="md3-tabs">
      <a href="{{ url_for('advanced_search.index') }}" class="md3-tab" role="button">Consultar corpus</a>
      <button type="button" class="md3-tab {% if active_tab == 'tab-token' or not active_tab %}md3-tab--active{% endif %}" data-tab="token">Token</button>
    </nav>
    
    <!-- Search Form -->
    <form id="corpus-search-form" action="{{ url_for('corpus.search') }}" method="get" class="md3-corpus-form">
      <!-- Hidden fields -->
      <input type="hidden" id="active_tab" name="active_tab" value="{{ request.values.get('active_tab', 'tab-token') }}">
      <input type="hidden" id="tokid-hidden" name="tokid_list" value="">
      
      <!-- Tab Token -->
      <div id="tab-token" class="md3-tab-content {% if active_tab == 'tab-token' %}md3-tab-content--active{% endif %}">
        <!-- Token ID Input Section -->
        <div class="tokid-filter-section">
          <div class="tokid-input-row">
            <div class="md3-outlined-textfield md3-outlined-textfield--flex">
              <input 
                type="text" 
                id="tokid-input" 
                class="md3-outlined-textfield__input"
                placeholder=" "
                autocomplete="off">
              <label for="tokid-input" class="md3-outlined-textfield__label">Token-IDs</label>
              <div class="md3-outlined-textfield__outline">
                <div class="md3-outlined-textfield__outline-start"></div>
                <div class="md3-outlined-textfield__outline-notch"></div>
                <div class="md3-outlined-textfield__outline-end"></div>
              </div>
            </div>
            <button type="button" class="md3-button-filled" id="tokid-add-btn">
              <span class="md3-button__label">Añadir</span>
            </button>
          </div>
          
          <div class="tokid-helper-row">
            <span class="tokid-helper-text">Token-IDs (Hash), separados por coma. El orden no importa.</span>
            <span id="tokid-count" class="tokid-count">0 Token-IDs activos</span>
          </div>
          
          <!-- Chip Container -->
          <div id="tokid-chip-container" class="tokid-chip-container"></div>
        </div>

        <!-- Actions -->
        <div class="md3-corpus-actions">
          <button type="button" class="md3-button-filled" id="token-search-btn">
            <span class="material-symbols-rounded">search</span>
            <span>Buscar</span>
          </button>
          <button type="button" class="md3-button-outlined" id="clear-tokens-btn">
            <span class="material-symbols-rounded">delete</span>
            <span>Limpiar todo</span>
          </button>
        </div>
      </div>
    </form>

    <!-- Token Results View (hidden until search performed) -->
    <section id="token-results" class="md3-view-content" style="display: none;">
      <section class="md3-corpus-results">
        <h2 class="md3-results-title">Resultados de Token-IDs</h2>
        
        <!-- DataTable Container -->
        <div class="md3-corpus-table-container">
          <table id="token-results-table" class="md3-corpus-table display nowrap" style="width:100%">
            <thead>
              <tr>
                <th>#</th>
                <th>Ctx.←</th>
                <th>Resultado</th>
                <th>Ctx.→</th>
                <th>Audio</th>
                <th>País</th>
                <th>Hablante</th>
                <th>Sexo</th>
                <th>Modo</th>
                <th>Discurso</th>
                <th>Token-ID</th>
                <th>Archivo</th>
              </tr>
            </thead>
            <tbody>
              <!-- DataTables (Server-Side) will populate this dynamically -->
            </tbody>
          </table>
        </div>
      </section>
    </section>
    
    <!-- Error Messages -->
    {% if error_message %}
    <div class="md3-corpus-alert">{{ error_message | safe }}</div>
    {% endif %}
    </section>
  </section>
</article>

<!-- Loading Overlay -->
<div id="loading-overlay" class="md3-corpus-loading" hidden>
  <div class="md3-corpus-loading__spinner">
    <span class="md3-title-large">Buscando...</span>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- Custom Script -->
<script>
  // Global configuration
  window.PLAYER_PATH = '{{ url_for("player.player_page") }}';
  window.ALLOW_PUBLIC_TEMP_AUDIO = '{{ 'true' if allow_public_temp_audio else 'false' }}';
  window.IS_AUTHENTICATED = '{{ 'true' if is_authenticated else 'false' }}';
</script>

<!-- Corpus Token Tab Module (ES6) -->
<script type="module" src="{{ url_for('static', filename='js/modules/corpus/token-tab.js') }}"></script>

<!-- Tab Switching -->
<script>
// Main tabs (Token only now, Advanced is a direct link)
document.querySelectorAll('.md3-tab[data-tab]').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.disabled) return;
    const targetTab = tab.dataset.tab;
    
    // Update tabs
    document.querySelectorAll('.md3-tab').forEach(t => t.classList.remove('md3-tab--active'));
    tab.classList.add('md3-tab--active');
    
    // Update content
    document.querySelectorAll('.md3-tab-content').forEach(c => c.classList.remove('md3-tab-content--active'));
    document.getElementById(`tab-${targetTab}`).classList.add('md3-tab-content--active');
    
    // Update hidden field
    document.getElementById('active_tab').value = `tab-${targetTab}`;
  });
});
</script>
{% endblock %}
