{% extends 'base.html' %}
{% from 'partials/page_navigation.html' import page_navigation %}

{% block page_title %}Guía de Búsqueda · CO.RA.PAN{% endblock %}

{% block extra_head %}
<!-- CSS for CQL Guide Dialog prompt styling -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/md3/components/advanced-search.css') }}">
{% endblock %}

{% block content %}
<div class="md3-page" role="main" aria-label="Guía de Búsqueda">
  <header class="md3-page__header">
    <div class="md3-hero md3-hero--card md3-hero__container">
      <div class="md3-hero__icon" aria-hidden="true"><span class="material-symbols-rounded">school</span></div>
      <div class="md3-hero__content">
        <p class="md3-body-small md3-hero__eyebrow">Corpus</p>
        <h1 class="md3-headline-medium md3-hero__title">Guía paso a paso</h1>
        <p class="md3-body-medium md3-hero__intro">Uso general de las herramientas de búsqueda.</p>
      </div>
    </div>
  </header>

  <main class="md3-text-page">
    <div class="md3-text-content">
    
    <!-- INTRODUCCIÓN -->
    <section class="md3-text-section">
      <p class="md3-body-large">
        Bienvenido a la herramienta de búsqueda del corpus CO.RA.PAN. La interfaz está diseñada para utilizarse sin conocimientos técnicos previos. En esta guía se describen las funciones disponibles en cada pestaña de búsqueda.
      </p>
    </section>

    <!-- 1. BÚSQUEDA SIMPLE -->
    <section class="md3-text-section">
      <h2 class="md3-title-large md3-section-title md3-text-heading">Consulta simple</h2>
      <p class="md3-body-large">
        La pestaña <strong>Consulta simple</strong> permite realizar búsquedas directas de palabras o secuencias. La consulta se introduce en el campo <strong>Consulta</strong> y puede combinarse con opciones adicionales de filtrado.
      </p>

      <h3 class="md3-title-medium md3-subsection-title">¿Cómo funciona?</h3>
      <ol class="md3-body-large md3-text-list">
        <li>Introducir la forma o secuencia en el cuadro de texto (por ejemplo: <code>casa</code>).</li>
        <li>Seleccionar la opción correspondiente en el campo <strong>Forma/Lema</strong>:
          <ul>
            <li><strong>Forma</strong> (primera mención): busca la forma escrita tal como se introduce.</li>
            <li>Lema: recupera todas las variantes flexionadas asociadas al lema indicado.</li>
          </ul>
        </li>
        <li>Aplicar filtros si es necesario. En la sección <strong>Filtros</strong> (primera mención) pueden seleccionarse <strong>País</strong>, <strong>Hablante</strong>, <strong>Sexo</strong>, <strong>Modo/registro</strong> y <strong>Discurso</strong>.</li>
        <li>En la sección <strong>Opciones</strong> (primera mención) pueden activarse las casillas «Incluir regiones» o «Ignorar acentos/mayúsculas».</li>
        <li>Para ejecutar la consulta, pulsar <strong>Buscar</strong> (primera mención). Para restablecer la configuración, utilizar el botón «Restablecer».</li>
      </ol>
    </section>

    <!-- 2. MODO AVANZADO -->
    <section class="md3-text-section">
      <h2 class="md3-title-large md3-section-title md3-text-heading">Modo avanzado (CQL)</h2>
      <p class="md3-body-large">
        La pestaña <strong>Modo avanzado (CQL)</strong> permite formular consultas estructuradas mediante el constructor de patrones o directamente con el lenguaje CQL. Este modo está orientado a la búsqueda de relaciones gramaticales y combinatorias.
      </p>

      <h3 class="md3-title-medium md3-subsection-title">El constructor de patrones</h3>
      <p class="md3-body-large">
        El apartado <strong>Búsquedas mediante el constructor CQL</strong> (primera mención) permite añadir bloques sucesivos mediante el botón <strong>Añadir token</strong> (primera mención). Cada bloque corresponde a una palabra de la secuencia y contiene los campos <strong>Campo</strong>, <strong>Tipo</strong> y <strong>Valor</strong>.
      </p>
      <ul class="md3-body-large md3-text-list">
        <li>Por ejemplo, para buscar un artículo seguido de un sustantivo:
          <ol>
            <li>Añadir un primer bloque y seleccionar en «Campo» la categoría correspondiente.</li>
            <li>Añadir un segundo bloque y seleccionar la categoría deseada.</li>
            <li>Ejecutar la consulta mediante el botón «Buscar».</li>
          </ol>
        </li>
      </ul>

      <h3 class="md3-title-medium md3-subsection-title">Uso del editor CQL</h3>
      <p class="md3-body-large">
        El apartado <strong>Editor CQL (modo experto)</strong> (primera mención) permite introducir consultas CQL manualmente en el campo «Consulta CQL». El modo experto se activa mediante la casilla «Activar modo experto (editar CQL manualmente)». También se proporciona un enlace a una guía rápida para asistir en la redacción de consultas complejas. Se puede consultar también aquí: <button type="button" id="cql-guide-link" class="md3-link md3-link--inline" style="background: none; border: none; cursor: pointer; padding: 0; font: inherit;">Guía rápida: usar un prompt para la IA</button>
      </p>
    </section>

    <!-- 3. BÚSQUEDA POR TOKEN -->
    <section class="md3-text-section">
      <h2 class="md3-title-large md3-section-title md3-text-heading">Búsqueda por Token</h2>
      <p class="md3-body-large">
        La pestaña <strong>Token</strong> permite recuperar instancias específicas del corpus empleando un identificador único (Token-ID). Esta función es útil cuando se desea volver a consultar ejemplos concretos encontrados en búsquedas previas.
      </p>
      <p class="md3-body-large">
        Para ello, basta con introducir uno o varios identificadores en el campo correspondiente, añadirlos mediante el botón «Añadir» y posteriormente seleccionar «Visualizar».
      </p>
    </section>

    <!-- 4. RESULTADOS Y ESTADÍSTICAS -->
    <section class="md3-text-section">
      <h2 class="md3-title-large md3-section-title md3-text-heading">Resultados y estadísticas</h2>
      <p class="md3-body-large">
        Tras ejecutar una consulta, se muestran las pestañas <strong>Resultados</strong> (primera mención) y <strong>Estadísticas</strong> (primera mención).
      </p>
      <ul class="md3-body-large md3-text-list">
        <li><strong>Resultados</strong>: presenta una lista de fragmentos donde aparece la coincidencia buscada. Puede consultarse el contexto, reproducir el audio original y visualizar la información sociolingüística correspondiente.</li>
        <li><strong>Estadísticas</strong>: ofrece gráficos que muestran la distribución de los resultados según los metadatos disponibles. Los datos pueden descargarse en formato CSV.</li>
      </ul>
    </section>

    </div>
  </main>

  <!-- CQL Guide Dialog (shared partial) -->
  {% include 'search/partials/cql_guide_dialog.html' %}
</div>

{{ page_navigation(prev_url=url_for('advanced_search.index'), prev_title='Consultar', next_url=url_for('corpus.composicion'), next_title='Composición') }}
{% endblock %}

{% block extra_scripts %}
<script>
  // Bind CQL Guide Dialog
  (function() {
    function initCqlGuideDialog() {
      const link = document.getElementById('cql-guide-link');
      const overlay = document.getElementById('cql-guide-overlay');
      const dialog = document.getElementById('cql-guide-dialog');
      const closeBtn = document.getElementById('cql-guide-close');
      const copyBtn = document.getElementById('cql-guide-copy');
      const promptText = document.getElementById('cql-guide-prompt');

      if (!link || !overlay || !dialog) {
        setTimeout(initCqlGuideDialog, 100);
        return;
      }

      link.onclick = function(e) {
        e.preventDefault();
        overlay.classList.add('active');
        overlay.removeAttribute('aria-hidden');
        document.body.style.overflow = 'hidden';
        dialog.focus();
        return false;
      };

    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      });
    }

    // Close on overlay click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
    });

    if (copyBtn && promptText) {
      copyBtn.addEventListener('click', function() {
        const textToCopy = (promptText.innerText || promptText.textContent || '').trim();
        if (!textToCopy) return;

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(textToCopy).then(function() {
            copyBtn.innerHTML = '<span class="material-symbols-rounded md3-button__icon" aria-hidden="true">check</span> Copiado';
            setTimeout(function() {
              copyBtn.innerHTML = '<span class="material-symbols-rounded md3-button__icon" aria-hidden="true">content_copy</span> Copiar prompt';
            }, 2000);
          }).catch(function() {
            fallbackCopy(textToCopy);
          });
        } else {
          fallbackCopy(textToCopy);
        }
      });
    }

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        copyBtn.innerHTML = '<span class="material-symbols-rounded md3-button__icon" aria-hidden="true">check</span> Copiado';
        setTimeout(function() {
          copyBtn.innerHTML = '<span class="material-symbols-rounded md3-button__icon" aria-hidden="true">content_copy</span> Copiar prompt';
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
      }
      document.body.removeChild(textarea);
    }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCqlGuideDialog);
    } else {
      // DOM already loaded, init immediately
      initCqlGuideDialog();
    }
  })();
</script>
{% endblock %}
