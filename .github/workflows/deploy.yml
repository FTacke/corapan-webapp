# =============================================================================
# CO.RA.PAN Production Deployment Workflow
# =============================================================================
#
# This workflow automatically deploys the application to the production server
# (marele.online.uni-marburg.de) when code is pushed to the main branch.
#
# The deployment runs on a self-hosted GitHub Actions runner installed on the
# production server itself. The runner executes the deploy_prod.sh script which:
#   - Updates the code from Git
#   - Builds a new Docker image
#   - Restarts the container with new image
#   - Runs database migrations
#
# Prerequisites on the server:
#   - GitHub self-hosted runner configured and running
#   - Docker installed
#   - /srv/webapps/corapan/{app,config,runtime} directories set up
#   - passwords.env configured in /srv/webapps/corapan/config/
#
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to marele.online.uni-marburg.de
    runs-on: self-hosted

    steps:
      - name: Deploy corapan-webapp
        run: |
          cd /srv/webapps/corapan/app
          bash scripts/deploy_prod.sh

      - name: Verify deployment
        run: |
          # Wait a moment for the container to fully start
          sleep 10

          # Check if container is running
          if docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E '^corapan-web-prod'; then
            echo "✓ Container corapan-web-prod is running"
          else
            echo "✗ Container corapan-web-prod is not running!"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            exit 1
          fi

          # Verify runtime-first mounts (container-side destinations only)
          mounts=$(docker inspect corapan-web-prod --format '{{range .Mounts}}{{println .Destination}}{{end}}' | sort)
          required=(
            "/app/data"
            "/app/media"
            "/app/logs"
            "/app/config"
          )
          for r in "${required[@]}"; do
            echo "$mounts" | grep -qx "$r" || { echo "✗ Missing mount destination: $r"; echo "$mounts"; exit 1; }
          done
          echo "✓ Mount destinations present"

          # Minimal write check (proves permissions)
          docker exec corapan-web-prod bash -lc 'set -e; touch /app/data/stats_temp/.deploy_write_test && rm -f /app/data/stats_temp/.deploy_write_test'
          echo "✓ Write check ok"

          # Health check
          curl -fsS http://127.0.0.1:6000/health

