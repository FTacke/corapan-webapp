# =============================================================================
# GitLab CI/CD Pipeline f√ºr CO.RA.PAN Webapp
# =============================================================================
#
# Vereinfachte Pipeline f√ºr wissenschaftliche Low-Traffic Webapp:
# - Syntax-Check (Python, Docker)
# - Optional: Docker Build
# - Optional: Deployment
#
# Keine aufw√§ndigen Tests n√∂tig (wissenschaftlicher Use Case)
# =============================================================================

stages:
  - validate
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  PYTHON_VERSION: "3.12"

# =============================================================================
# VALIDATION STAGE: Syntax-Checks
# =============================================================================

# Python Syntax Check
validate:python:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --quiet ruff
  script:
    - echo "‚úÖ Checking Python syntax with ruff..."
    - ruff check src/ --select E,F --ignore E501
    - echo "‚úÖ Python syntax is valid!"
  allow_failure: false
  only:
    - branches
    - merge_requests
    - main

# Docker Build Test (no push)
validate:docker:
  stage: validate
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "‚úÖ Testing Docker build..."
    - docker build -t test-build .
    - echo "‚úÖ Docker build successful!"
  allow_failure: false
  only:
    - branches
    - merge_requests
    - main

# =============================================================================
# BUILD STAGE: Docker Image (only on main)
# =============================================================================

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üêã Building and pushing Docker image..."
    - docker build -t $DOCKER_IMAGE .
    - docker tag $DOCKER_IMAGE $CI_REGISTRY_IMAGE:latest
    - docker push $DOCKER_IMAGE
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "‚úÖ Docker image pushed to registry"
  only:
    - main
    - tags

# =============================================================================
# DEPLOY STAGE: Manual Deployment
# =============================================================================

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "üöÄ Deploying to production server..."
    - echo "üìã Instructions:"
    - echo "   1. SSH to server: ssh user@vhrz2184"
    - echo "   2. Navigate: cd ~/corapan"
    - echo "   3. Run update: ./update.sh"
    - echo ""
    - echo "‚ö†Ô∏è  Manual deployment required!"
    - echo "    (Automatic deployment not configured)"
  only:
    - main
  when: manual
  environment:
    name: production
    url: https://corapan.your-domain.com

# =============================================================================
# OPTIONAL: Security Scan (allow failure, informational only)
# =============================================================================

security:scan:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --quiet safety
  script:
    - echo "üîí Checking for known security vulnerabilities..."
    - safety check --json || true
    - echo "‚ÑπÔ∏è  Security scan completed (informational only)"
  allow_failure: true
  only:
    - main
    - merge_requests

# =============================================================================
# Notes:
# =============================================================================
# 
# ‚úÖ Was die Pipeline macht:
#   - Validiert Python-Syntax (schnell, keine Tests n√∂tig)
#   - Testet Docker Build (stellt sicher dass Image baubar ist)
#   - Baut Docker Image nur bei Push zu main
#   - Deployment ist manuell (wie gew√ºnscht)
#
# ‚ùå Was die Pipeline NICHT macht:
#   - Keine Unit Tests (nicht n√∂tig f√ºr Low-Traffic wissenschaftliche App)
#   - Kein Linting (zu streng f√ºr Prototypen)
#   - Kein automatisches Deployment (manuell gew√ºnscht)
#
# üîß F√ºr sp√§ter (optional):
#   - pytest hinzuf√ºgen wenn Tests geschrieben werden
#   - Automatisches Deployment via SSH
#   - Trivy Security Scan
    url: https://staging.corapan.example.com
