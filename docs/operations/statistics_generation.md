# Corpus Statistics Generation and Serving

## Overview

Corpus statistics (visualizations and JSON metadata) are **runtime data** generated by a pipeline script and served through Flask API endpoints. The statistics directory must be explicitly configured via environment variables—there is no fallback to repo-based paths.

**Key Principle:** Statistics are NOT repo assets. They must be generated to and served from a runtime-configured directory.

## Components

### 1. Generator: `LOKAL/_0_json/05_publish_corpus_statistics.py`

Generates corpus statistics visualizations (PNG) and metadata (JSON) from pre-processed CSV data.

#### Requirements

Statistics output directory **MUST** be specified via one of:
1. **CLI argument** (highest priority):
   ```bash
   python 05_publish_corpus_statistics.py --out /custom/path
   ```
   
2. **Environment variable** (required if no `--out`):
   ```bash
   export CORAPAN_RUNTIME_ROOT=/data/runtime
   python 05_publish_corpus_statistics.py
   # Output: /data/runtime/data/public/statistics/
   ```

If neither is provided, the script exits with code 2 and displays a clear error message:
```
ERROR: Statistics output directory not configured
Set environment variable:    export CORAPAN_RUNTIME_ROOT=/runtime/path
Use CLI argument:            python 05_publish_corpus_statistics.py --out /custom/path
```

#### Input Files

- `LOKAL/_0_json/results/corpus_statistics.csv` — Per-country statistics
- `LOKAL/_0_json/results/corpus_statistics_across_countries.csv` — Aggregate statistics

#### Generated Files

```
statistics/
├── corpus_stats.json              # Global statistics JSON (all countries)
├── viz_total_corpus.png          # Total corpus composition pie chart
├── viz_genero_profesionales.png  # Professional gender distribution
├── viz_modo_genero_profesionales.png  # Mode × Gender stacked bar chart
└── viz_{COUNTRY}_resumen.png     # Per-country summary visualization (one per country)
```

### 2. Application Configuration: `src/app/config/__init__.py`

The `BaseConfig` class requires explicit configuration of statistics directory via environment variables:

```python
_runtime_root = os.getenv('CORAPAN_RUNTIME_ROOT')
_explicit_stats_dir = os.getenv('PUBLIC_STATS_DIR')

if _explicit_stats_dir:
    PUBLIC_STATS_DIR = Path(_explicit_stats_dir)
elif _runtime_root:
    PUBLIC_STATS_DIR = Path(_runtime_root) / "data" / "public" / "statistics"
else:
    raise RuntimeError("PUBLIC_STATS_DIR environment variable not configured...")
```

**Configuration Options (in priority order):**

1. **Explicit path** (highest priority):
   ```bash
   export PUBLIC_STATS_DIR=/path/to/statistics
   python -m src.app.main
   ```

2. **Derived from runtime root** (recommended):
   ```bash
   export CORAPAN_RUNTIME_ROOT=/runtime/path
   python -m src.app.main
   # Reads from: /runtime/path/data/public/statistics/
   ```

3. **No configuration**: App fails on startup with helpful error message

### 3. API Endpoints: `src/app/routes/corpus.py`

Two endpoints serve statistics from the configured `PUBLIC_STATS_DIR`:

#### Endpoint 1: `GET /corpus/api/` + `corpus_stats`

Serves the pre-generated `corpus_stats.json` file with global corpus metadata.

**Request:**
```http
GET /corpus/api/ corpus_stats HTTP/1.1
```

**Response (200 OK):**
```json
{
  "metadata": {
    "timestamp": "2026-01-17T12:34:56",
    "total_word_count": 15000000,
    "total_duration": "12345:30:45",
    "country_count": 12
  },
  "countries": {
    "ES": {
      "pro": {
        "word_count": 500000,
        "percentage": 35.5
      },
      ...
    }
  }
}
```

**Response (404 Not Found):**
```json
{
  "error": "Corpus statistics not available",
  "message": "Statistics file not found at /runtime/path/data/public/statistics/corpus_stats.json. Run: python LOKAL/_0_json/05_publish_corpus_statistics.py"
}
```

#### Endpoint 2: `GET /corpus/api/statistics/<path:filename>`

Serves PNG and JSON statistics files from runtime directory.

**Security Features:**
- Allowlist file extensions: `.png`, `.json` only
- Safe path resolution (prevents directory traversal)
- Returns 404 if file not found

**Requests:**
```http
GET /corpus/api/statistics/viz_total_corpus.png HTTP/1.1
GET /corpus/api/statistics/viz_ES_resumen.png HTTP/1.1
GET /corpus/api/statistics/corpus_stats.json HTTP/1.1
```

**Response (200 OK):** File content (PNG image or JSON)

**Response (400 Bad Request):** Invalid file extension
```json
{
  "error": "Invalid file type",
  "message": "Only ['.png', '.json'] files are allowed"
}
```

**Response (404 Not Found):** File doesn't exist
```json
{
  "error": "File not found",
  "message": "Statistics file not found: viz_FR_resumen.png"
}
```

## Usage

### Local Development

#### Setup Minimal Runbook

```bash
# 1. Set runtime root (or any directory for development)
export CORAPAN_RUNTIME_ROOT=$PWD/data/runtime

# 2. Run step 04 to generate input CSVs
python LOKAL/_0_json/04_internal_country_statistics.py

# 3. Run step 05 to generate statistics
python LOKAL/_0_json/05_publish_corpus_statistics.py

# 4. Verify files were created
ls -la $CORAPAN_RUNTIME_ROOT/data/public/statistics/

# 5. Start the app
export FLASK_ENV=development
python -m src.app.main

# 6. Test endpoints
curl http://localhost:8000/corpus/api/ + corpus_stats
curl http://localhost:8000/corpus/api/statistics/viz_total_corpus.png
```

### Production Deployment

#### Setup with Persistent Runtime Directory

```bash
# 1. Configure runtime directory (persistent storage)
export CORAPAN_RUNTIME_ROOT=/data/runtime

# 2. Run generator to populate statistics
python LOKAL/_0_json/05_publish_corpus_statistics.py

# 3. Verify files
ls -la /data/runtime/data/public/statistics/

# 4. Start app in production mode
export FLASK_ENV=production
python -m src.app.main
```

#### Docker Deployment

```yaml
services:
  corapan-app:
    environment:
      CORAPAN_RUNTIME_ROOT: /runtime
      FLASK_ENV: production
    volumes:
      - runtime_data:/runtime
    depends_on:
      - statistics-generator  # Or run manually before starting app
      
  # Optional: Statistics generator as separate container
  statistics-generator:
    build:
      context: .
      dockerfile: Dockerfile.stats
    environment:
      CORAPAN_RUNTIME_ROOT: /runtime
    volumes:
      - runtime_data:/runtime
    command: python LOKAL/_0_json/05_publish_corpus_statistics.py
```

## Architecture

```
┌─────────────────────────────────────┐
│  CSV Data (Step 04)                 │
│  - corpus_statistics.csv             │
│  - corpus_statistics_across_*.csv   │
└────────────┬────────────────────────┘
             │
             ↓
┌─────────────────────────────────────┐
│  Generator (Step 05)                │
│  05_publish_corpus_statistics.py    │
│  REQUIRES: CORAPAN_RUNTIME_ROOT     │
│  or --out argument                  │
│  - Reads CSV                        │
│  - Generates PNG visualizations    │
│  - Generates JSON metadata         │
└────────────┬────────────────────────┘
             │
             ↓ (writes to configured runtime directory)
   ┌──────────────────────────────┐
   │ ${CORAPAN_RUNTIME_ROOT}/     │
   │ data/public/statistics/      │
   │                              │
   │ ├── corpus_stats.json        │
   │ ├── viz_*.png                │
   │ └── ...                      │
   └────────────┬─────────────────┘
                │
                ↓ (SAME LOCATION)
    ┌────────────────────────────┐
    │  App Configuration         │
    │  PUBLIC_STATS_DIR          │
    │  (reads from env var)      │
    └────────────┬───────────────┘
                 │
                 ↓
    ┌────────────────────────────┐
    │  API Endpoints             │
    │  /corpus/api/ + corpus_stats  │
    │  /corpus/api/statistics/.. │
    │  (serve from runtime dir)  │
    └────────────┬───────────────┘
                 │
                 ↓
    ┌────────────────────────────┐
    │  Frontend Templates        │
    │  Display visualizations    │
    │  Render statistics         │
    └────────────────────────────┘
```

## Troubleshooting

### App Fails to Start with RuntimeError

**Symptom:**
```
RuntimeError: PUBLIC_STATS_DIR environment variable not configured.
Statistics are RUNTIME DATA and must be explicitly provided.
```

**Solution:** Set environment variable before starting app:
```bash
export CORAPAN_RUNTIME_ROOT=/data/runtime
python -m src.app.main
```

### Generator Script Exits with Code 2

**Symptom:**
```
ERROR: Statistics output directory not configured
Set environment variable:    export CORAPAN_RUNTIME_ROOT=/runtime/path
```

**Solution:** Provide output directory:
```bash
export CORAPAN_RUNTIME_ROOT=/data/runtime
python LOKAL/_0_json/05_publish_corpus_statistics.py
```

### 404 Error from `/corpus/api/` + `corpus_stats`

**Cause:** Statistics JSON not yet generated.

**Solution:**
1. Generate statistics first:
   ```bash
   export CORAPAN_RUNTIME_ROOT=/data/runtime
   python LOKAL/_0_json/05_publish_corpus_statistics.py
   ```

2. Verify files exist:
   ```bash
   ls -la $CORAPAN_RUNTIME_ROOT/data/public/statistics/corpus_stats.json
   ```

3. Check app config (if stats were generated but app can't find them):
   ```bash
   # Make sure app is using same CORAPAN_RUNTIME_ROOT
   echo $CORAPAN_RUNTIME_ROOT
   ```

### 400 Error from `/corpus/api/statistics/<file>`

**Cause:** Trying to access a file with disallowed extension.

**Solution:** Only `.png` and `.json` files are served. Verify filename:
```bash
# Valid:
curl /corpus/api/statistics/viz_total_corpus.png
curl /corpus/api/statistics/corpus_stats.json

# Invalid (will return 400):
curl /corpus/api/statistics/../../etc/passwd  # traversal attempt
curl /corpus/api/statistics/config.txt        # .txt not allowed
```

## Environment Variables

| Variable | Type | Required | Example | Effect |
|----------|------|----------|---------|--------|
| `CORAPAN_RUNTIME_ROOT` | path | Conditional | `/data/runtime` | Generator outputs to `${CORAPAN_RUNTIME_ROOT}/data/public/statistics/`; App reads from same |
| `PUBLIC_STATS_DIR` | path | Conditional | `/statistics` | App serves from this directory (takes priority over `CORAPAN_RUNTIME_ROOT`) |
| `FLASK_ENV` | string | No | `production` | Controls app mode (debug=False in production) |

**Minimum required:** Either `CORAPAN_RUNTIME_ROOT` OR `PUBLIC_STATS_DIR` must be set before:
- Running generator (requires one to output)
- Starting app (requires one to serve)

## Related Files

- Generator: [LOKAL/_0_json/05_publish_corpus_statistics.py](../../LOKAL/_0_json/05_publish_corpus_statistics.py)
- App Config: [src/app/config/__init__.py](../../src/app/config/__init__.py)
- API Routes: [src/app/routes/corpus.py](../../src/app/routes/corpus.py)
- Templates: [templates/pages/corpus_metadata.html](../../templates/pages/corpus_metadata.html)
- Frontend JS: [static/js/modules/corpus-metadata.js](../../static/js/modules/corpus-metadata.js)
- CSV Generator: [LOKAL/_0_json/04_internal_country_statistics.py](../../LOKAL/_0_json/04_internal_country_statistics.py)
