# Corpus Statistics Generation and Serving

## Overview

Corpus statistics (visualizations and JSON metadata) are generated by a pipeline script and served through a Flask API endpoint. The system supports both local development and production deployments with configurable output directories.

## Components

### 1. Generator: `LOKAL/_0_json/05_publish_corpus_statistics.py`

Generates corpus statistics visualizations (PNG) and metadata (JSON) from pre-processed CSV data.

#### Input Files

- `LOKAL/_0_json/results/corpus_statistics.csv` — Per-country statistics
- `LOKAL/_0_json/results/corpus_statistics_across_countries.csv` — Aggregate statistics

#### Output Files

Generated statistics are written to one of these locations (in priority order):

1. **Custom directory** (if `--out` CLI argument provided):
   ```bash
   python 05_publish_corpus_statistics.py --out /custom/path
   ```

2. **Runtime directory** (if `CORAPAN_RUNTIME_ROOT` environment variable is set):
   ```bash
   export CORAPAN_RUNTIME_ROOT=/data/runtime
   python 05_publish_corpus_statistics.py
   # Output: /data/runtime/data/public/statistics/
   ```

3. **Default directory** (fallback):
   ```bash
   python 05_publish_corpus_statistics.py
   # Output: static/img/statistics/
   ```

#### Generated Files

```
statistics/
├── corpus_stats.json              # Global statistics JSON (all countries)
├── viz_total_corpus.png          # Total corpus composition pie chart
├── viz_genero_profesionales.png  # Professional gender distribution
├── viz_modo_genero_profesionales.png  # Mode × Gender stacked bar chart
└── viz_{COUNTRY}_resumen.png     # Per-country summary visualization (one per country)
```

### 2. Application Configuration: `src/app/config/__init__.py`

The `BaseConfig` class defines the `PUBLIC_STATS_DIR` setting:

```python
PUBLIC_STATS_DIR = Path(
    os.getenv('CORAPAN_RUNTIME_ROOT', str(PROJECT_ROOT))
)
if PUBLIC_STATS_DIR == PROJECT_ROOT:
    # Default: statistics in static folder
    PUBLIC_STATS_DIR = PROJECT_ROOT / "static" / "img" / "statistics"
else:
    # Runtime path: statistics in runtime data directory
    PUBLIC_STATS_DIR = PUBLIC_STATS_DIR / "data" / "public" / "statistics"
```

**Behavior:**
- If `CORAPAN_RUNTIME_ROOT` is set: `${CORAPAN_RUNTIME_ROOT}/data/public/statistics/`
- Otherwise: `static/img/statistics/`

### 3. API Endpoint: `src/app/routes/corpus.py`

#### Endpoint: `GET /corpus/api/corpus_stats`

Serves the pre-generated `corpus_stats.json` file.

**Request:**
```http
GET /corpus/api/corpus_stats HTTP/1.1
```

**Response (200 OK):**
```json
{
  "metadata": {
    "timestamp": "2026-01-17T12:34:56",
    "total_word_count": 15000000,
    "total_duration": "12345:30:45",
    "country_count": 12
  },
  "countries": {
    "ES": {
      "pro": {
        "word_count": 500000,
        "percentage": 35.5
      },
      "otro": {...},
      "pro_gender": {...},
      "pro_mode_gender": {...}
    },
    ...
  }
}
```

**Response (404 Not Found):**
```json
{
  "error": "Corpus statistics not available",
  "message": "Run pipeline step 05: python LOKAL/_0_json/05_publish_corpus_statistics.py"
}
```

## Usage

### Local Development

#### 1. Generate Statistics

Ensure prerequisite step has completed:

```bash
# Step 04: Generate input CSV files
python LOKAL/_0_json/04_internal_country_statistics.py

# Step 05: Generate statistics visualizations
python LOKAL/_0_json/05_publish_corpus_statistics.py
```

**Output:** `static/img/statistics/`

#### 2. Verify Generation

```bash
# Check that files exist
ls -la static/img/statistics/

# Start the app and test endpoint
python -m src.app.main
curl http://localhost:8000/corpus/api/corpus_stats
```

### Production Deployment

#### Setup with Runtime Directory

```bash
# Set environment variable
export CORAPAN_RUNTIME_ROOT=/data/runtime

# Run generator (writes to /data/runtime/data/public/statistics/)
python LOKAL/_0_json/05_publish_corpus_statistics.py

# Verify files
ls -la /data/runtime/data/public/statistics/

# Start app (reads from configured path)
export FLASK_ENV=production
python -m src.app.main
```

#### Docker Deployment

In your Docker Compose or container orchestration:

```yaml
services:
  corapan-app:
    environment:
      CORAPAN_RUNTIME_ROOT: /runtime
      FLASK_ENV: production
    volumes:
      - runtime_data:/runtime
```

## Architecture

```
┌─────────────────────────────────────┐
│  CSV Data (Step 04)                 │
│  - corpus_statistics.csv             │
│  - corpus_statistics_across_*.csv   │
└────────────┬────────────────────────┘
             │
             ↓
┌─────────────────────────────────────┐
│  Generator (Step 05)                │
│  05_publish_corpus_statistics.py    │
│  - Reads CSV                        │
│  - Generates PNG visualizations    │
│  - Generates JSON metadata         │
└────────────┬────────────────────────┘
             │
             ↓ (writes to configured output directory)
        ┌────────────────────────────┐
        │ Output Options:            │
        │ 1. static/img/statistics/  │
        │ 2. ${RUNTIME}/data/public/ │
        └────────────┬───────────────┘
                     │
                     ↓
        ┌─────────────────────────┐
        │  App Configuration      │
        │  PUBLIC_STATS_DIR       │
        │  (reads from dir)       │
        └────────────┬────────────┘
                     │
                     ↓
        ┌─────────────────────────┐
        │  API Endpoint           │
        │  /corpus/api/corpus_stats│
        │  (serves JSON)          │
        └─────────────────────────┘
                     │
                     ↓
        ┌─────────────────────────┐
        │  Frontend/Clients       │
        │  Display visualizations │
        │  Render statistics      │
        └─────────────────────────┘
```

## Troubleshooting

### 404 Error from `/corpus/api/corpus_stats`

**Cause:** Statistics JSON not found or output directory misconfigured.

**Solution:**
1. Verify generator script has been run:
   ```bash
   python LOKAL/_0_json/05_publish_corpus_statistics.py
   ```

2. Check configured output directory:
   ```bash
   # Local development
   ls -la static/img/statistics/corpus_stats.json
   
   # Production with CORAPAN_RUNTIME_ROOT
   export CORAPAN_RUNTIME_ROOT=/runtime
   ls -la /runtime/data/public/statistics/corpus_stats.json
   ```

3. Verify environment variables:
   ```bash
   echo $CORAPAN_RUNTIME_ROOT
   ```

### Files Not Written to Expected Location

**Cause:** Inconsistency between generator output and app config.

**Solution:**
- **Generator override:** Use CLI argument:
  ```bash
  python LOKAL/_0_json/05_publish_corpus_statistics.py --out /custom/path
  ```
- **App config override:** Set `CORAPAN_RUNTIME_ROOT` before starting app:
  ```bash
  export CORAPAN_RUNTIME_ROOT=/data/runtime
  python -m src.app.main
  ```

## Environment Variables

| Variable | Example | Effect |
|----------|---------|--------|
| `CORAPAN_RUNTIME_ROOT` | `/data/runtime` | Generator outputs to `${CORAPAN_RUNTIME_ROOT}/data/public/statistics/`; App reads from same location |
| `FLASK_ENV` | `production` | Controls app config (production defaults, dev debugging) |

## Related Files

- Generator: [LOKAL/_0_json/05_publish_corpus_statistics.py](../../LOKAL/_0_json/05_publish_corpus_statistics.py)
- App Config: [src/app/config/__init__.py](../../src/app/config/__init__.py)
- API Route: [src/app/routes/corpus.py](../../src/app/routes/corpus.py)
- CSV Inputs: [LOKAL/_0_json/04_internal_country_statistics.py](../../LOKAL/_0_json/04_internal_country_statistics.py)
